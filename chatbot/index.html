<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebAI ‚Äî Local AI Chat in Your Browser</title>
    <meta name="description"
        content="Run an LLM entirely in your browser using WebGPU. Private, unmonitored, no server needed." />
    <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/x-icon" href="../images/favicon/favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #171717;
            color: #e5e5e5;
            height: 100vh;
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
        .app {
            display: flex;
            height: 100vh;
        }

        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
        .sidebar {
            width: 260px;
            background: #0f0f0f;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.25s ease;
        }

        .sidebar-header {
            padding: 14px 16px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-brand {
            font-size: 1.05rem;
            font-weight: 700;
            color: #10b981;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-brand svg {
            width: 22px;
            height: 22px;
        }

        .btn-new-chat {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #1f1f1f;
            border: 1px solid #333;
            border-radius: 8px;
            color: #d4d4d4;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }

        .btn-new-chat:hover {
            background: #292929;
            border-color: #444;
        }

        .btn-new-chat svg {
            width: 16px;
            height: 16px;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.08) transparent;
        }

        .chat-list::-webkit-scrollbar {
            width: 4px;
        }

        .chat-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 2px;
        }

        .chat-list-item {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.82rem;
            color: #a3a3a3;
            cursor: pointer;
            transition: background 0.12s, color 0.12s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            position: relative;
        }

        .chat-list-item:hover {
            background: #1f1f1f;
            color: #e5e5e5;
        }

        .chat-list-item.active {
            background: #262626;
            color: #fff;
        }

        .chat-list-item-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-delete {
            opacity: 0;
            background: none;
            border: none;
            color: #737373;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: opacity 0.12s, color 0.12s;
            flex-shrink: 0;
        }

        .chat-list-item:hover .chat-delete {
            opacity: 1;
        }

        .chat-delete:hover {
            color: #ef4444;
        }

        .chat-delete svg {
            width: 14px;
            height: 14px;
        }

        .chat-list-empty {
            text-align: center;
            color: #525252;
            font-size: 0.78rem;
            padding: 24px 16px;
        }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid #2a2a2a;
            font-size: 0.7rem;
            color: #525252;
            text-align: center;
        }

        /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* ‚îÄ‚îÄ Hamburger (mobile only) ‚îÄ‚îÄ */
        .hamburger-bar {
            display: none;
            padding: 8px 16px;
            border-bottom: 1px solid #2a2a2a;
            background: #171717;
        }

        .hamburger {
            background: none;
            border: none;
            color: #a3a3a3;
            cursor: pointer;
            padding: 4px;
        }

        .hamburger svg {
            width: 22px;
            height: 22px;
        }

        /* ‚îÄ‚îÄ Progress (always at top of main) ‚îÄ‚îÄ */
        .progress-strip {
            padding: 8px 20px;
            border-bottom: 1px solid #2a2a2a;
            display: none;
        }

        .progress-strip.show {
            display: block;
        }

        .progress-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .progress-meta span {
            font-size: 0.72rem;
            color: #737373;
        }

        .progress-meta .pct {
            color: #10b981;
            font-family: 'Inter', monospace;
        }

        .progress-track {
            height: 4px;
            border-radius: 2px;
            background: #262626;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 2px;
            background: #10b981;
            transition: width 0.3s ease;
        }

        /* ‚îÄ‚îÄ Chat area ‚îÄ‚îÄ */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.06) transparent;
        }

        .chat-area::-webkit-scrollbar {
            width: 5px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 3px;
        }

        /* Messages */
        .msg-row {
            display: flex;
            gap: 12px;
            max-width: 720px;
            width: 100%;
            margin: 0 auto;
            animation: fadeIn 0.2s ease;
        }

        .msg-row.user {
            justify-content: flex-end;
        }

        .msg-row.ai {
            justify-content: flex-start;
        }

        .msg-avatar {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .msg-avatar.ai-av {
            background: #10b981;
            color: #fff;
        }

        .msg-avatar.user-av {
            background: #3b82f6;
            color: #fff;
        }

        .msg-bubble {
            padding: 10px 16px;
            border-radius: 14px;
            line-height: 1.6;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 85%;
        }

        .msg-bubble.user-b {
            background: #262626;
            color: #e5e5e5;
            border-bottom-right-radius: 4px;
        }

        .msg-bubble.ai-b {
            background: #1f1f1f;
            color: #d4d4d4;
            border-bottom-left-radius: 4px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Typing dots */
        .typing span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
            margin: 0 2px;
            animation: dotBounce 1.4s infinite both;
        }

        .typing span:nth-child(2) {
            animation-delay: 0.15s;
        }

        .typing span:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes dotBounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Welcome */
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 32px 16px;
        }

        .welcome-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.15);
        }

        .welcome-icon svg {
            width: 28px;
            height: 28px;
            color: #fff;
        }

        .welcome h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #e5e5e5;
            margin-bottom: 8px;
        }

        .welcome p {
            font-size: 0.85rem;
            color: #737373;
            max-width: 380px;
            line-height: 1.6;
        }

        .welcome-tags {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
        }

        .welcome-tags span {
            font-size: 0.72rem;
            padding: 5px 12px;
            border-radius: 999px;
            background: #1f1f1f;
            border: 1px solid #2a2a2a;
            color: #737373;
        }

        /* ‚îÄ‚îÄ Input bar ‚îÄ‚îÄ */
        .input-bar {
            padding: 12px 20px 16px;
            border-top: 1px solid #2a2a2a;
            background: #171717;
        }

        .input-cell {
            display: flex;
            align-items: center;
            max-width: 720px;
            margin: 0 auto;
            background: #1f1f1f;
            border: 1px solid #333;
            border-radius: 12px;
            overflow: hidden;
            transition: border-color 0.15s;
        }


        /* Text input ‚Äî takes all remaining space */
        .input-cell input {
            flex: 1;
            min-width: 0;
            background: transparent;
            border: none;
            color: #e5e5e5;
            padding: 12px 16px;
            font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
            outline: none;
        }

        .input-cell input::placeholder {
            color: #525252;
        }

        .input-cell input:disabled {
            opacity: 0.4;
        }

        /* Divider between input and model select */
        .input-divider {
            width: 1px;
            height: 22px;
            background: #333;
            flex-shrink: 0;
        }

        /* Model dropdown ‚Äî blends into the cell */
        .select-model {
            background: transparent;
            border: none;
            color: #a3a3a3;
            padding: 10px 28px 10px 12px;
            font-size: 0.76rem;
            font-family: 'Inter', sans-serif;
            outline: none;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%2310b981' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            flex-shrink: 0;
            max-width: 190px;
            transition: color 0.15s;
        }

        .select-model:hover {
            color: #d4d4d4;
        }

        .select-model option {
            background: #1f1f1f;
            color: #d4d4d4;
        }

        .select-model:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Send button ‚Äî sits flush on the right */
        .btn-send {
            width: 44px;
            height: 44px;
            background: #10b981;
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background 0.15s;
            border-radius: 0 11px 11px 0;
        }

        .btn-send:hover:not(:disabled) {
            background: #059669;
        }

        .btn-send:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .btn-send svg {
            width: 18px;
            height: 18px;
        }

        .input-hint {
            text-align: center;
            font-size: 0.65rem;
            color: #404040;
            margin-top: 6px;
        }

        /* ‚îÄ‚îÄ Mobile sidebar overlay ‚îÄ‚îÄ */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 90;
        }

        .sidebar-overlay.show {
            display: block;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 100;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .hamburger-bar {
                display: flex;
            }

            .select-model {
                max-width: 120px;
                font-size: 0.7rem;
                padding-right: 24px;
            }
        }
    </style>
</head>

<body>
    <div class="app">

        <!-- ‚ïê‚ïê Sidebar ‚ïê‚ïê -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                    </svg>
                    WebAI
                </div>
                <button class="btn-new-chat" onclick="newChat()" title="New chat">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    New
                </button>
            </div>
            <div class="chat-list" id="chatList">
                <div class="chat-list-empty" id="chatListEmpty">No conversations yet</div>
            </div>
            <div class="sidebar-footer">Runs 100% in your browser</div>
        </aside>

        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

        <!-- ‚ïê‚ïê Main area ‚ïê‚ïê -->
        <div class="main">

            <!-- Hamburger (mobile only) -->
            <div class="hamburger-bar">
                <button class="hamburger" onclick="toggleSidebar()" title="Menu">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
            </div>

            <!-- Progress bar (at very top of main content) -->
            <div id="progressArea" class="progress-strip">
                <div class="progress-meta">
                    <span id="progressLabel">Loading‚Ä¶</span>
                    <span id="progressPct" class="pct">0%</span>
                </div>
                <div class="progress-track">
                    <div id="progressBar" class="progress-fill" style="width:0%"></div>
                </div>
            </div>

            <!-- Chat -->
            <div id="chatArea" class="chat-area">
                <div class="welcome" id="welcomeScreen">
                    <div class="welcome-icon">
                        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456z" />
                        </svg>
                    </div>
                    <h2>Welcome to WebAI</h2>
                    <p>Pick a model from the dropdown below and start chatting. Everything runs locally on your device ‚Äî
                        nothing leaves your browser.</p>
                    <div class="welcome-tags">
                        <span>üîí Fully Private</span>
                        <span>‚ö° WebGPU Accelerated</span>
                        <span>üåê No Server</span>
                        <span>üíæ Chats Saved Locally</span>
                    </div>
                </div>
            </div>

            <!-- Input bar with model selector -->
            <div class="input-bar">
                <form class="input-cell" onsubmit="sendMessage(event)">
                    <input id="userInput" type="text" placeholder="Message WebAI‚Ä¶" autocomplete="off" disabled />
                    <div class="input-divider"></div>
                    <select id="modelSelect" class="select-model">
                        <option value="SmolLM2-360M-Instruct-q4f16_1-MLC">SmolLM2 360M (~200 MB)</option>
                        <option value="SmolLM2-1.7B-Instruct-q4f16_1-MLC" selected>SmolLM2 1.7B (~1 GB)</option>
                        <option value="Qwen2.5-1.5B-Instruct-q4f16_1-MLC">Qwen 2.5 1.5B (~1 GB)</option>
                        <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B (~0.7 GB)</option>
                        <option value="Llama-3.2-3B-Instruct-q4f16_1-MLC">Llama 3.2 3B (~1.8 GB)</option>
                        <option value="Phi-3.5-mini-instruct-q4f16_1-MLC">Phi 3.5 Mini (~2.3 GB)</option>
                        <option value="gemma-2-2b-it-q4f16_1-MLC">Gemma 2 2B (~1.4 GB)</option>
                        <option value="Qwen2.5-3B-Instruct-q4f16_1-MLC">Qwen 2.5 3B (~1.9 GB)</option>
                        <option value="Mistral-7B-Instruct-v0.3-q4f16_1-MLC">Mistral 7B (~4 GB)</option>
                        <option value="Qwen2.5-7B-Instruct-q4f16_1-MLC">Qwen 2.5 7B (~4.5 GB)</option>
                    </select>
                    <div class="input-divider"></div>
                    <button type="submit" id="sendBtn" class="btn-send" disabled title="Send">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </svg>
                    </button>
                </form>
                <div class="input-hint">WebAI runs entirely in your browser. Your conversations are never sent anywhere.
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WebLLM + App Logic ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        /* ‚ïê‚ïê State ‚ïê‚ïê */
        let engine = null;
        let isGenerating = false;
        let currentModelId = null;
        let isLoading = false;

        const STORAGE_KEY = "webai_chats";
        let chats = loadChats();
        let activeChatId = null;

        /* ‚îÄ‚îÄ DOM ‚îÄ‚îÄ */
        const chatArea = document.getElementById("chatArea");
        const welcomeScreen = document.getElementById("welcomeScreen");
        const userInput = document.getElementById("userInput");
        const sendBtn = document.getElementById("sendBtn");
        const modelSelect = document.getElementById("modelSelect");
        const progressArea = document.getElementById("progressArea");
        const progressLabel = document.getElementById("progressLabel");
        const progressPct = document.getElementById("progressPct");
        const progressBar = document.getElementById("progressBar");
        const chatListEl = document.getElementById("chatList");
        const sidebar = document.getElementById("sidebar");
        const sidebarOverlay = document.getElementById("sidebarOverlay");

        /* ‚îÄ‚îÄ Expose to inline handlers ‚îÄ‚îÄ */
        window.sendMessage = sendMessage;
        window.newChat = newChat;
        window.switchChat = switchChat;
        window.deleteChat = deleteChat;
        window.toggleSidebar = toggleSidebar;
        window.closeSidebar = closeSidebar;

        /* ‚ïê‚ïê Auto-load model on dropdown change ‚ïê‚ïê */
        modelSelect.addEventListener("change", () => {
            loadModel(modelSelect.value);
        });

        /* ‚ïê‚ïê LocalStorage ‚ïê‚ïê */
        function loadChats() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
            catch { return []; }
        }
        function saveChats() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
        }
        function getActiveChat() {
            return chats.find(c => c.id === activeChatId) || null;
        }

        /* ‚ïê‚ïê Sidebar rendering ‚ïê‚ïê */
        function renderChatList() {
            const sorted = [...chats].sort((a, b) => b.updatedAt - a.updatedAt);
            if (chats.length === 0) {
                chatListEl.innerHTML = '<div class="chat-list-empty">No conversations yet</div>';
                return;
            }
            chatListEl.innerHTML = sorted.map(c => {
                const isActive = c.id === activeChatId;
                return `<div class="chat-list-item ${isActive ? 'active' : ''}" onclick="switchChat('${c.id}')">
                <span class="chat-list-item-title">${escapeHTML(c.title)}</span>
                <button class="chat-delete" onclick="event.stopPropagation(); deleteChat('${c.id}')" title="Delete">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/></svg>
                </button>
            </div>`;
            }).join("");
        }

        /* ‚ïê‚ïê Chat actions ‚ïê‚ïê */
        function newChat() {
            activeChatId = null;
            renderChatArea();
            renderChatList();
            closeSidebar();
        }

        function switchChat(id) {
            activeChatId = id;
            renderChatArea();
            renderChatList();
            closeSidebar();
        }

        function deleteChat(id) {
            chats = chats.filter(c => c.id !== id);
            saveChats();
            if (activeChatId === id) { activeChatId = null; renderChatArea(); }
            renderChatList();
        }

        function createChat(firstMessage) {
            const id = 'chat_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
            const title = firstMessage.length > 40 ? firstMessage.slice(0, 40) + '‚Ä¶' : firstMessage;
            const chat = { id, title, model: modelSelect.value, messages: [], updatedAt: Date.now() };
            chats.push(chat);
            activeChatId = id;
            saveChats();
            renderChatList();
            return chat;
        }

        /* ‚ïê‚ïê Render chat area ‚ïê‚ïê */
        function renderChatArea() {
            const chat = getActiveChat();
            if (!chat || chat.messages.length === 0) {
                chatArea.innerHTML = '';
                chatArea.appendChild(welcomeScreen);
                welcomeScreen.style.display = 'flex';
                return;
            }
            welcomeScreen.style.display = 'none';
            chatArea.innerHTML = '';
            chat.messages.forEach(m => appendMessageDOM(m.role === "user" ? "user" : "ai", m.content));
        }

        /* ‚ïê‚ïê Model loading (auto-triggered on dropdown change) ‚ïê‚ïê */
        async function loadModel(modelId) {
            if (isLoading) return;
            if (modelId === currentModelId && engine) return; // already loaded

            isLoading = true;
            modelSelect.disabled = true;
            sendBtn.disabled = true;
            userInput.disabled = true;
            progressArea.classList.add("show");
            progressLabel.textContent = "Preparing‚Ä¶";
            progressPct.textContent = "0%";
            progressBar.style.width = "0%";

            if (engine) {
                try { await engine.unload(); } catch (_) { }
                engine = null;
                currentModelId = null;
            }

            const initProgressCallback = (report) => {
                progressLabel.textContent = report.text || "Downloading model‚Ä¶";
                const pct = Math.round((report.progress || 0) * 100);
                progressPct.textContent = pct + "%";
                progressBar.style.width = pct + "%";
            };

            try {
                engine = await webllm.CreateMLCEngine(modelId, { initProgressCallback });
                currentModelId = modelId;
                progressArea.classList.remove("show");
                modelSelect.disabled = false;
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            } catch (err) {
                console.error(err);
                progressLabel.textContent = "‚ùå " + (err.message || "Failed to load model.");
                modelSelect.disabled = false;
            } finally {
                isLoading = false;
            }
        }

        /* ‚ïê‚ïê Send message ‚ïê‚ïê */
        async function sendMessage(e) {
            e.preventDefault();
            if (isGenerating) return;

            const text = userInput.value.trim();
            if (!text) return;

            // Auto-load model if none loaded yet
            if (!engine) {
                await loadModel(modelSelect.value);
                if (!engine) return; // load failed
            }

            userInput.value = "";

            let chat = getActiveChat();
            if (!chat) chat = createChat(text);

            welcomeScreen.style.display = 'none';
            if (welcomeScreen.parentElement === chatArea) chatArea.removeChild(welcomeScreen);

            appendMessageDOM("user", text);
            chat.messages.push({ role: "user", content: text });
            chat.updatedAt = Date.now();
            saveChats();

            isGenerating = true;
            sendBtn.disabled = true;
            userInput.disabled = true;
            modelSelect.disabled = true;

            const typingEl = showTypingIndicator();

            try {
                const aiEl = appendMessageDOM("ai", "");
                typingEl.remove();

                const stream = await engine.chat.completions.create({
                    messages: chat.messages,
                    stream: true,
                    temperature: 0.7,
                    max_tokens: 1024,
                });

                let fullReply = "";
                for await (const chunk of stream) {
                    const delta = chunk.choices?.[0]?.delta?.content || "";
                    fullReply += delta;
                    aiEl.querySelector('.msg-bubble').textContent = fullReply;
                    chatArea.scrollTop = chatArea.scrollHeight;
                }

                chat.messages.push({ role: "assistant", content: fullReply });
                chat.updatedAt = Date.now();
                saveChats();
            } catch (err) {
                console.error(err);
                typingEl.remove();
                appendMessageDOM("ai", "‚ö†Ô∏è Error: " + (err.message || "Something went wrong."));
            } finally {
                isGenerating = false;
                sendBtn.disabled = false;
                userInput.disabled = false;
                modelSelect.disabled = false;
                userInput.focus();
            }
        }

        /* ‚ïê‚ïê DOM helpers ‚ïê‚ïê */
        function appendMessageDOM(role, text) {
            const isUser = role === "user";
            const row = document.createElement("div");
            row.className = `msg-row ${isUser ? 'user' : 'ai'}`;
            if (isUser) {
                row.innerHTML = `<div class="msg-bubble user-b">${escapeHTML(text)}</div><div class="msg-avatar user-av">You</div>`;
            } else {
                row.innerHTML = `<div class="msg-avatar ai-av">AI</div><div class="msg-bubble ai-b">${escapeHTML(text)}</div>`;
            }
            chatArea.appendChild(row);
            chatArea.scrollTop = chatArea.scrollHeight;
            return row;
        }

        function showTypingIndicator() {
            const row = document.createElement("div");
            row.className = "msg-row ai";
            row.innerHTML = `<div class="msg-avatar ai-av">AI</div><div class="msg-bubble ai-b typing"><span></span><span></span><span></span></div>`;
            chatArea.appendChild(row);
            chatArea.scrollTop = chatArea.scrollHeight;
            return row;
        }

        function escapeHTML(str) {
            const d = document.createElement("div");
            d.textContent = str;
            return d.innerHTML;
        }

        /* ‚ïê‚ïê Mobile sidebar ‚ïê‚ïê */
        function toggleSidebar() {
            sidebar.classList.toggle("open");
            sidebarOverlay.classList.toggle("show");
        }
        function closeSidebar() {
            sidebar.classList.remove("open");
            sidebarOverlay.classList.remove("show");
        }

        /* ‚ïê‚ïê Init ‚ïê‚ïê */
        renderChatList();
        renderChatArea();

        // WebGPU check
        if (!navigator.gpu) {
            modelSelect.disabled = true;
            welcomeScreen.innerHTML = `
            <p style="color:#ef4444; font-weight:500; margin-bottom:8px;">‚ö†Ô∏è WebGPU is not supported in this browser.</p>
            <p style="color:#737373; font-size:0.82rem;">Please use Chrome 113+, Edge 113+, or another WebGPU-enabled browser.</p>`;
        } else {
            // Auto-load the default model on page open
            loadModel(modelSelect.value);
        }
    </script>
</body>

</html>