<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>My Spotify Stats</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #1db954, #191414);
                color: white;
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
            }

            .header {
                text-align: center;
                margin-bottom: 40px;
            }

            .header h1 {
                font-size: 3rem;
                margin-bottom: 10px;
                color: #1db954;
            }

            .upload-container {
                background: rgba(25, 20, 20, 0.9);
                border-radius: 15px;
                padding: 40px;
                text-align: center;
                border: 2px dashed #1db954;
                margin: 40px auto;
                max-width: 600px;
                transition: all 0.3s ease;
            }

            .upload-container:hover {
                border-color: #1ed760;
                background: rgba(25, 20, 20, 0.95);
            }

            .upload-container.dragover {
                border-color: #1ed760;
                background: rgba(29, 185, 84, 0.1);
                transform: scale(1.02);
            }

            .upload-icon {
                font-size: 4rem;
                margin-bottom: 20px;
                color: #1db954;
            }

            .upload-text {
                font-size: 1.2rem;
                margin-bottom: 20px;
            }

            .upload-input {
                display: none;
            }

            .upload-button {
                background: #1db954;
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 25px;
                font-size: 1.1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                margin: 10px;
            }

            .upload-button:hover {
                background: #1ed760;
                transform: translateY(-2px);
            }

            .back-button {
                background: rgba(255, 255, 255, 0.1);
                color: white;
                border: 1px solid #1db954;
                padding: 10px 20px;
                border-radius: 20px;
                font-size: 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                margin-bottom: 20px;
            }

            .back-button:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: translateY(-1px);
            }

            .processing {
                text-align: center;
                padding: 40px;
                display: none;
            }

            .processing-steps {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin: 20px 0;
                flex-wrap: wrap;
            }

            .processing-step {
                padding: 10px 20px;
                border-radius: 25px;
                background: rgba(255, 255, 255, 0.1);
                opacity: 0.5;
            }

            .processing-step.active {
                background: #1db954;
                opacity: 1;
            }

            .processing-step.completed {
                background: #1ed760;
                opacity: 1;
            }

            .loading {
                display: inline-block;
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #1db954;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .stats-overview {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }

            .stat-card {
                background: rgba(25, 20, 20, 0.9);
                border-radius: 15px;
                padding: 25px;
                text-align: center;
                border: 1px solid rgba(29, 185, 84, 0.3);
            }

            .stat-card h3 {
                color: #1db954;
                margin-bottom: 15px;
                font-size: 1.1rem;
            }

            .big-number {
                font-size: 2.5rem;
                font-weight: bold;
                color: #1ed760;
                margin-bottom: 5px;
            }

            .sub-stat {
                color: #ccc;
                font-size: 0.9rem;
                margin-top: 8px;
            }

            .time-period {
                text-align: center;
                margin-bottom: 30px;
            }

            .time-period select {
                background: rgba(25, 20, 20, 0.9);
                color: white;
                border: 1px solid #1db954;
                padding: 10px 15px;
                border-radius: 25px;
                font-size: 1rem;
                cursor: pointer;
            }

            .progress-bar {
                width: 100%;
                height: 8px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 4px;
                overflow: hidden;
                margin-top: 10px;
            }

            .progress-fill {
                height: 100%;
                background: #1db954;
                transition: width 0.3s ease;
            }

            .content-tabs {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-bottom: 30px;
                flex-wrap: wrap;
            }

            .tab-button {
                background: rgba(255, 255, 255, 0.1);
                color: white;
                border: 1px solid #1db954;
                padding: 10px 20px;
                border-radius: 25px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .tab-button.active {
                background: #1db954;
                transform: translateY(-2px);
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .charts-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 30px;
                margin-bottom: 40px;
            }

            .chart-container {
                background: rgba(25, 20, 20, 0.9);
                border-radius: 15px;
                padding: 25px;
                border: 1px solid rgba(29, 185, 84, 0.3);
                position: relative;
                min-height: 350px;
            }

            .chart-container.hourly-patterns {
                min-height: 200px;
                padding: 15px;
            }

            .chart-container.weekly-patterns {
                min-height: 600px;
                padding: 40px;
            }

            .chart-title {
                color: #1db954;
                margin-bottom: 20px;
                text-align: center;
                font-size: 1.2rem;
            }

            .chart-container canvas {
                max-width: 100% !important;
                max-height: 300px !important;
                width: auto !important;
                height: auto !important;
            }

            .chart-container.weekly-patterns canvas {
                max-height: 500px !important;
                height: 500px !important;
            }

            .top-lists-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 30px;
                margin-bottom: 40px;
            }

            .top-list-container {
                background: rgba(25, 20, 20, 0.9);
                border-radius: 15px;
                padding: 25px;
                border: 1px solid rgba(29, 185, 84, 0.3);
            }

            .top-list-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            .top-list-title {
                color: #1db954;
                font-size: 1.2rem;
            }

            .search-box {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(29, 185, 84, 0.5);
                border-radius: 20px;
                padding: 8px 15px;
                color: white;
                font-size: 0.9rem;
                width: 150px;
            }

            .search-box::placeholder {
                color: #ccc;
            }

            .top-list {
                max-height: 400px;
                overflow-y: auto;
                list-style: none;
            }

            .top-list::-webkit-scrollbar {
                width: 6px;
            }

            .top-list::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
            }

            .top-list::-webkit-scrollbar-thumb {
                background: #1db954;
                border-radius: 3px;
            }

            .top-list li {
                padding: 12px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .rank {
                background: #1db954;
                color: white;
                width: 25px;
                height: 25px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.8rem;
                font-weight: bold;
                flex-shrink: 0;
            }

            .list-item-content {
                flex: 1;
            }

            .list-item-name {
                font-weight: bold;
                margin-bottom: 2px;
            }

            .list-item-stats {
                color: #ccc;
                font-size: 0.8rem;
            }

            .show-more-btn {
                background: rgba(29, 185, 84, 0.2);
                border: 1px solid #1db954;
                color: #1db954;
                padding: 8px 16px;
                border-radius: 15px;
                cursor: pointer;
                margin-top: 15px;
                font-size: 0.9rem;
                width: 100%;
            }

            .error {
                background: rgba(255, 0, 0, 0.1);
                border: 1px solid red;
                border-radius: 10px;
                padding: 20px;
                margin: 20px 0;
                text-align: center;
                color: #ff6b6b;
                display: none;
            }

            .file-info {
                background: rgba(25, 20, 20, 0.9);
                border-radius: 10px;
                padding: 20px;
                margin: 20px 0;
                border: 1px solid rgba(29, 185, 84, 0.3);
                cursor: pointer;
                display: none;
                max-width: 100%;
                word-wrap: break-word;
            }

            .file-info ol {
                padding-left: 20px;
                line-height: 1.6;
                text-align: left;
            }

            .file-info li {
                margin-bottom: 8px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                text-align: left;
            }

            .file-info a {
                word-break: break-all;
            }

            .file-info h4 {
                color: #1db954;
                margin-bottom: 10px;
            }

            .insights-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }

            .insight-card {
                background: rgba(25, 20, 20, 0.9);
                border-radius: 15px;
                padding: 20px;
                border: 1px solid rgba(29, 185, 84, 0.3);
            }

            .tab-content {
                background: rgba(25, 20, 20, 0.3);
                border-radius: 15px;
                padding: 20px;
                margin-top: 20px;
            }

            .insight-title {
                color: #1db954;
                font-size: 1.1rem;
                margin-bottom: 15px;
            }

            .insight-value {
                font-size: 1.8rem;
                font-weight: bold;
                color: #1ed760;
                margin-bottom: 5px;
            }

            .insight-detail {
                color: #ccc;
                font-size: 0.9rem;
            }

            .heatmap {
                display: grid;
                grid-template-columns: repeat(24, 1fr);
                gap: 2px;
                margin: 15px 0;
            }

            .heatmap-cell {
                aspect-ratio: 1;
                border-radius: 2px;
                transition: transform 0.2s ease;
            }

            .heatmap-cell:hover {
                transform: scale(1.2);
            }

            .heatmap-legend {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 10px;
                font-size: 0.8rem;
                color: #ccc;
            }

            /* Custom tooltip styles */
            .custom-tooltip {
                position: absolute;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                pointer-events: none;
                z-index: 1000;
                border: 1px solid #1db954;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                opacity: 0;
                transform: translateY(-5px);
                transition:
                    opacity 0.1s ease,
                    transform 0.1s ease;
            }

            .custom-tooltip.show {
                opacity: 1;
                transform: translateY(0);
            }

            /* Platform usage list styles */
            .platform-list {
                height: 100%;
                overflow-y: auto;
                background: rgba(15, 15, 15, 0.5);
                border-radius: 8px;
                padding: 10px;
            }

            .platform-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 0;
                border-bottom: 1px solid rgba(29, 185, 84, 0.1);
                color: white;
            }

            .platform-item:last-child {
                border-bottom: none;
            }

            .platform-name {
                font-weight: 500;
                color: #1db954;
            }

            .platform-hours {
                color: #ccc;
                font-size: 0.9rem;
            }

            .platform-list::-webkit-scrollbar {
                width: 8px;
            }

            .platform-list::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 4px;
            }

            .platform-list::-webkit-scrollbar-thumb {
                background: #1db954;
                border-radius: 4px;
            }

            @media (max-width: 768px) {
                .header h1 {
                    font-size: 2rem;
                }

                .stats-overview {
                    grid-template-columns: 1fr;
                }

                .upload-container {
                    padding: 30px 20px;
                }

                .charts-grid {
                    grid-template-columns: 1fr;
                }

                .top-lists-grid {
                    grid-template-columns: 1fr;
                }

                .search-box {
                    font-size: 14px;
                }

                .content-tabs {
                    overflow-x: auto;
                }

                .tab-button {
                    min-width: 100px;
                    white-space: nowrap;
                }

                .chart-container.weekly-patterns {
                    min-height: 400px;
                    padding: 20px;
                }

                .chart-container.weekly-patterns canvas {
                    max-height: 300px !important;
                    height: 300px !important;
                }

                .platform-list {
                    height: 100px !important;
                }
            }

            .hidden {
                display: none !important;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div
                class="header"
                style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-direction: column;
                    margin-bottom: 40px;
                "
            >
                <div
                    style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 100%;
                    "
                >
                    <h1
                        style="
                            font-size: 3rem;
                            margin-bottom: 10px;
                            color: #1db954;
                            margin: 0 auto;
                            text-align: center;
                            flex: 1 1 auto;
                        "
                    >
                        🎵 My Spotify Stats
                    </h1>
                    <a
                        href="../index.html"
                        style="
                            font-size: 0.95rem;
                            color: #b3b3b3;
                            background: none;
                            border: none;
                            padding: 6px 12px;
                            text-decoration: none;
                            border-radius: 4px;
                            transition: color 0.2s;
                            margin-left: 24px;
                            align-self: center;
                            flex-shrink: 0;
                        "
                        onmouseover="this.style.color='#1db954';"
                        onmouseout="this.style.color='#b3b3b3';"
                    >
                        My Other Sites
                    </a>
                </div>
                <p style="width: 100%; text-align: center; margin-top: 18px">
                    Upload your Spotify Extended Streaming History to see
                    detailed analytics
                </p>
            </div>

            <!-- Upload View -->
            <div id="uploadView">
                <div class="upload-container" id="dropZone">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">
                        <strong
                            >Upload your Spotify Extended Streaming
                            History</strong
                        >
                        <br />
                        Drop your .zip file here or click to browse
                        <br />
                        <small
                            >Your data is processed locally - nothing is
                            uploaded to any server</small
                        >
                    </div>
                    <input
                        type="file"
                        id="fileInput"
                        class="upload-input"
                        accept=".zip"
                    />
                    <button
                        class="upload-button"
                        onclick="document.getElementById('fileInput').click()"
                    >
                        Choose File
                    </button>
                    <div class="file-info" style="display: none" id="fileInfo">
                        <h4>How to get your Spotify data:</h4>
                        <ol>
                            <li>
                                Go to
                                <a
                                    href="https://www.spotify.com/account/privacy/"
                                    target="_blank"
                                    style="color: #1db954"
                                    >Spotify Privacy Settings</a
                                >
                            </li>
                            <li>Scroll down to "Download your data"</li>
                            <li>
                                <strong style="color: #1db954"
                                    >⚠️ IMPORTANT:</strong
                                >
                                Request
                                <strong>"Extended streaming history"</strong>
                                ONLY
                                <br />
                                <span style="color: #ff6b6b; font-weight: bold">
                                    ❌ DO NOT select any other options - uncheck
                                    everything else!
                                </span>
                            </li>
                            <li>
                                Wait for Spotify to email you the download link
                                (can take up to 30 days)
                            </li>
                            <li>
                                Download your data as a
                                <strong>.zip</strong> file and upload it
                                here.<br />
                                <em>Note for macOS users:</em> If your browser
                                automatically unzips the file, please
                                re-compress it (right-click -> compress) before
                                uploading.
                            </li>
                        </ol>
                        <!-- TikTok Embed Start -->
                        <blockquote
                            class="tiktok-embed"
                            cite="https://www.tiktok.com/@achneerov/video/7524009272519249158"
                            data-video-id="7524009272519249158"
                            style="
                                margin: 20px 0;
                                min-width: 325px;
                                max-width: 605px;
                            "
                        >
                            <section>
                                <a
                                    target="_blank"
                                    title="@achneerov"
                                    href="https://www.tiktok.com/@achneerov?refer=embed"
                                    >@achneerov</a
                                >
                                <p>
                                    How to download your Spotify extended
                                    streaming history
                                </p>
                                <a
                                    target="_blank"
                                    title="♬ original sound - Ach Neerov"
                                    href="https://www.tiktok.com/music/original-sound-7524009272519249158?refer=embed"
                                    >♬ original sound - Ach Neerov</a
                                >
                            </section>
                        </blockquote>
                        <script
                            async
                            src="https://www.tiktok.com/embed.js"
                        ></script>
                        <!-- TikTok Embed End -->
                    </div>
                    <button
                        class="upload-button"
                        onclick="toggleFileInfo()"
                        style="background: rgba(255, 255, 255, 0.1)"
                    >
                        📋 How to get my data?
                    </button>
                </div>
            </div>

            <!-- Processing View -->
            <div id="processingView" class="processing">
                <h2>Processing your Spotify data...</h2>
                <div class="processing-steps">
                    <div class="processing-step" id="step1">
                        Reading ZIP file
                    </div>
                    <div class="processing-step" id="step2">
                        Parsing JSON data
                    </div>
                    <div class="processing-step" id="step3">
                        Analyzing patterns
                    </div>
                    <div class="processing-step" id="step4">
                        Generating insights
                    </div>
                </div>
                <div class="loading"></div>
                <p>This may take a few moments...</p>
            </div>

            <!-- Stats View -->
            <div id="statsView" class="hidden">
                <button class="back-button" onclick="showUploadView()">
                    ← Upload New Data
                </button>

                <div class="time-period">
                    <label for="periodSelect">Time Period: </label>
                    <select
                        id="periodSelect"
                        onchange="applyFilter(this.value)"
                    >
                        <option value="all">All Time</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="last30">Last 30 Days</option>
                        <option value="last7">Last 7 Days</option>
                    </select>
                </div>

                <!-- Stats Overview -->
                <div class="stats-overview">
                    <div class="stat-card">
                        <h3>Total Listening Time</h3>
                        <div class="big-number" id="totalTime">0h</div>
                        <div class="sub-stat" id="totalTracks">
                            0 tracks played
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Daily Average</h3>
                        <div class="big-number" id="avgDaily">0h</div>
                        <div class="sub-stat" id="avgTracks">
                            0 tracks per day
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Unique Artists</h3>
                        <div class="big-number" id="uniqueArtists">0</div>
                        <div class="sub-stat" id="uniqueTracks">
                            0 unique tracks
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Completion Rate</h3>
                        <div class="big-number" id="skipRate">0%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="completionBar"></div>
                        </div>
                        <div class="sub-stat">Songs played 30+ seconds</div>
                    </div>
                </div>

                <!-- Content Tabs -->
                <div class="content-tabs">
                    <button
                        class="tab-button active"
                        onclick="showTab('overview')"
                    >
                        Overview
                    </button>
                    <button class="tab-button" onclick="showTab('insights')">
                        Insights
                    </button>
                    <button class="tab-button" onclick="showTab('top-lists')">
                        Top Lists
                    </button>
                    <button class="tab-button" onclick="showTab('charts')">
                        Charts
                    </button>
                </div>

                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content active">
                    <div class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-title">🌍 Top Country</div>
                            <div class="insight-value" id="topCountry">--</div>
                            <div class="insight-detail" id="countryDetail">
                                -- listens
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">
                                📱 Favorite Platform
                            </div>
                            <div class="insight-value" id="topPlatform">--</div>
                            <div class="insight-detail" id="platformDetail">
                                -- hours
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">🔀 Shuffle Usage</div>
                            <div class="insight-value" id="shuffleRate">0%</div>
                            <div class="insight-detail">of your listening</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">
                                📶 Offline Listening
                            </div>
                            <div class="insight-value" id="offlineRate">0%</div>
                            <div class="insight-detail">of your time</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">⏭️ Skip Rate</div>
                            <div class="insight-value" id="actualSkipRate">
                                0%
                            </div>
                            <div class="insight-detail">tracks skipped</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">🎯 Discovery Score</div>
                            <div class="insight-value" id="discoveryScore">
                                0
                            </div>
                            <div class="insight-detail">new tracks found</div>
                        </div>
                    </div>

                    <!-- Listening Patterns Heatmap -->
                    <div class="chart-container hourly-patterns">
                        <div class="chart-title">
                            ⏰ Listening Patterns by Hour
                        </div>
                        <div class="heatmap" id="hourlyHeatmap"></div>
                        <div class="heatmap-legend">
                            <span>12 AM</span>
                            <span>6 AM</span>
                            <span>12 PM</span>
                            <span>6 PM</span>
                            <span>12 AM</span>
                        </div>
                    </div>
                </div>

                <!-- Insights Tab -->
                <div id="insights-tab" class="tab-content">
                    <div class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-title">🏆 Longest Session</div>
                            <div class="insight-value" id="longestSession">
                                0h
                            </div>
                            <div class="insight-detail" id="sessionDetail">
                                consecutive listening
                            </div>
                        </div>

                        <div class="insight-card">
                            <div class="insight-title">📅 Most Active Day</div>
                            <div class="insight-value" id="mostActiveDay">
                                --
                            </div>
                            <div class="insight-detail" id="activeDetails">
                                --
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">🌙 Night Owl Score</div>
                            <div class="insight-value" id="nightOwlScore">
                                0%
                            </div>
                            <div class="insight-detail">
                                listening after 10 PM
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">🌅 Early Bird Score</div>
                            <div class="insight-value" id="earlyBirdScore">
                                0%
                            </div>
                            <div class="insight-detail">
                                listening before 8 AM
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">📊 Variety Score</div>
                            <div class="insight-value" id="varietyScore">0</div>
                            <div class="insight-detail">
                                different artists per week
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Pattern -->
                    <div class="chart-container weekly-patterns">
                        <div class="chart-title">
                            📅 Weekly Listening Pattern
                        </div>
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>

                <!-- Top Lists Tab -->
                <div id="top-lists-tab" class="tab-content">
                    <div class="top-lists-grid">
                        <div class="top-list-container">
                            <div class="top-list-header">
                                <h3 class="top-list-title">🎤 Top Artists</h3>
                                <input
                                    type="text"
                                    class="search-box"
                                    placeholder="Search artists..."
                                    oninput="filterList('artists', this.value)"
                                />
                            </div>
                            <ul class="top-list" id="topArtists"></ul>
                            <button
                                class="show-more-btn"
                                id="showMoreArtists"
                                onclick="showMoreItems('artists')"
                            >
                                Show More Artists
                            </button>
                        </div>

                        <div class="top-list-container">
                            <div class="top-list-header">
                                <h3 class="top-list-title">🎵 Top Tracks</h3>
                                <input
                                    type="text"
                                    class="search-box"
                                    placeholder="Search tracks..."
                                    oninput="filterList('tracks', this.value)"
                                />
                            </div>
                            <ul class="top-list" id="topTracks"></ul>
                            <button
                                class="show-more-btn"
                                id="showMoreTracks"
                                onclick="showMoreItems('tracks')"
                            >
                                Show More Tracks
                            </button>
                        </div>

                        <div class="top-list-container">
                            <div class="top-list-header">
                                <h3 class="top-list-title">💿 Top Albums</h3>
                                <input
                                    type="text"
                                    class="search-box"
                                    placeholder="Search albums..."
                                    oninput="filterList('albums', this.value)"
                                />
                            </div>
                            <ul class="top-list" id="topAlbums"></ul>
                            <button
                                class="show-more-btn"
                                id="showMoreAlbums"
                                onclick="showMoreItems('albums')"
                            >
                                Show More Albums
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Charts Tab -->
                <div id="charts-tab" class="tab-content">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">
                                📈 Listening Over Time
                            </div>
                            <canvas id="timeChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">📱 Platform Usage</div>
                            <div
                                style="
                                    display: flex;
                                    flex-direction: column;
                                    gap: 15px;
                                "
                            >
                                <div style="height: 250px">
                                    <canvas id="platformChart"></canvas>
                                </div>
                                <div style="height: 120px">
                                    <div
                                        class="platform-list"
                                        id="platformList"
                                    ></div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">
                                🌍 Listening by Country
                            </div>
                            <canvas id="countryChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">
                                ⏰ Hourly Distribution
                            </div>
                            <canvas id="hourlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error View -->
            <div id="errorView" class="error">
                <h3>Error Processing File</h3>
                <p id="errorMessage"></p>
                <button class="upload-button" onclick="showUploadView()">
                    Try Again
                </button>
            </div>
        </div>

        <script>
            let allData = [];
            let filteredData = [];
            let charts = {};
            let topLists = {
                artists: { data: [], displayed: 20, filtered: [] },
                tracks: { data: [], displayed: 20, filtered: [] },
                albums: { data: [], displayed: 20, filtered: [] },
            };

            // View management
            function showUploadView() {
                document.getElementById("uploadView").style.display = "block";
                document.getElementById("processingView").style.display =
                    "none";
                document.getElementById("statsView").classList.add("hidden");
                document.getElementById("errorView").style.display = "none";

                // Clear previous data
                allData = [];
                filteredData = [];

                // Destroy existing charts
                Object.values(charts).forEach((chart) => chart.destroy());
                charts = {};
            }

            function showProcessingView() {
                document.getElementById("uploadView").style.display = "none";
                document.getElementById("processingView").style.display =
                    "block";
                document.getElementById("statsView").classList.add("hidden");
                document.getElementById("errorView").style.display = "none";

                // Reset processing steps
                ["step1", "step2", "step3", "step4"].forEach((stepId) => {
                    const step = document.getElementById(stepId);
                    step.classList.remove("active", "completed");
                });
            }

            function showStatsView() {
                document.getElementById("uploadView").style.display = "none";
                document.getElementById("processingView").style.display =
                    "none";
                document.getElementById("statsView").classList.remove("hidden");
                document.getElementById("errorView").style.display = "none";
            }

            function showErrorView(message) {
                document.getElementById("uploadView").style.display = "none";
                document.getElementById("processingView").style.display =
                    "none";
                document.getElementById("statsView").classList.add("hidden");
                document.getElementById("errorView").style.display = "block";
                document.getElementById("errorMessage").textContent = message;
            }

            function showTab(tabName) {
                // Hide all tabs
                document.querySelectorAll(".tab-content").forEach((tab) => {
                    tab.classList.remove("active");
                });
                document.querySelectorAll(".tab-button").forEach((btn) => {
                    btn.classList.remove("active");
                });

                // Show selected tab
                document
                    .getElementById(tabName + "-tab")
                    .classList.add("active");
                event.target.classList.add("active");
            }

            function toggleFileInfo() {
                const fileInfo = document.getElementById("fileInfo");
                if (fileInfo.style.display === "none") {
                    fileInfo.style.display = "block";
                } else {
                    fileInfo.style.display = "none";
                }
            }

            function setProcessingStep(stepNumber) {
                // Mark previous steps as completed
                for (let i = 1; i < stepNumber; i++) {
                    const step = document.getElementById(`step${i}`);
                    step.classList.remove("active");
                    step.classList.add("completed");
                }

                // Mark current step as active
                const currentStep = document.getElementById(
                    `step${stepNumber}`,
                );
                currentStep.classList.add("active");
            }

            async function processZipFile(file) {
                try {
                    showProcessingView();
                    setProcessingStep(1);

                    const zip = new JSZip();
                    const contents = await zip.loadAsync(file);

                    setProcessingStep(2);

                    // Find streaming history files
                    const streamingFiles = [];
                    contents.forEach((relativePath, file) => {
                        // Skip macOS metadata files and directories
                        if (
                            relativePath.includes("__MACOSX") ||
                            relativePath.startsWith("._") ||
                            relativePath.includes("/._") ||
                            file.dir
                        ) {
                            return;
                        }

                        if (
                            relativePath.includes("Streaming_History_Audio") &&
                            relativePath.endsWith(".json")
                        ) {
                            console.log(`Found valid file: ${relativePath}`);
                            streamingFiles.push({
                                path: relativePath,
                                file: file,
                            });
                        }
                    });

                    if (streamingFiles.length === 0) {
                        throw new Error(
                            "No Spotify streaming history files found in the ZIP. Make sure you uploaded the Extended Streaming History data.",
                        );
                    }

                    setProcessingStep(3);

                    // Process each file
                    const allRecords = [];
                    console.log(
                        `Processing ${streamingFiles.length} valid streaming history files...`,
                    );

                    for (const { path, file } of streamingFiles) {
                        try {
                            const content = await file.async("text");

                            // Additional check for valid JSON content
                            if (
                                !content.trim().startsWith("[") &&
                                !content.trim().startsWith("{")
                            ) {
                                console.warn(
                                    `Skipping ${path}: Not valid JSON content`,
                                );
                                continue;
                            }

                            const data = JSON.parse(content);
                            if (Array.isArray(data)) {
                                console.log(
                                    `Loaded ${data.length} records from ${path}`,
                                );
                                allRecords.push(...data);
                            } else {
                                console.warn(
                                    `Skipping ${path}: Data is not an array`,
                                );
                            }
                        } catch (e) {
                            console.warn(
                                `Error processing ${path}:`,
                                e.message,
                            );
                        }
                    }

                    // Filter valid records
                    allData = allRecords.filter(
                        (item) =>
                            item.master_metadata_track_name &&
                            item.master_metadata_album_artist_name &&
                            item.ms_played > 0 &&
                            item.ts,
                    );

                    if (allData.length === 0) {
                        throw new Error(
                            "No valid listening records found in the uploaded files.",
                        );
                    }

                    setProcessingStep(4);

                    console.log(
                        `Successfully processed ${allData.length} valid listening records from ${streamingFiles.length} files`,
                    );
                    console.log(
                        `Data spans from ${new Date(Math.min(...allData.map((item) => new Date(item.ts)))).toLocaleDateString()} to ${new Date(Math.max(...allData.map((item) => new Date(item.ts)))).toLocaleDateString()}`,
                    );

                    // Short delay to show final step
                    await new Promise((resolve) => setTimeout(resolve, 500));

                    // Mark final step as completed
                    document.getElementById("step4").classList.remove("active");
                    document.getElementById("step4").classList.add("completed");

                    // Initialize stats view
                    applyFilter("all");
                    showStatsView();
                } catch (error) {
                    console.error("Error processing ZIP file:", error);
                    showErrorView(error.message);
                }
            }

            // Stats functions
            function applyFilter(period) {
                const now = new Date();
                let startDate = new Date(0);

                switch (period) {
                    case "last7":
                        startDate = new Date(
                            now.getTime() - 7 * 24 * 60 * 60 * 1000,
                        );
                        break;
                    case "last30":
                        startDate = new Date(
                            now.getTime() - 30 * 24 * 60 * 60 * 1000,
                        );
                        break;
                    case "2024":
                        startDate = new Date("2024-01-01");
                        break;
                    case "2023":
                        startDate = new Date("2023-01-01");
                        break;
                    case "2022":
                        startDate = new Date("2022-01-01");
                        break;
                    default:
                        startDate = new Date(0);
                }

                filteredData = allData.filter((item) => {
                    const itemDate = new Date(item.ts);
                    return (
                        itemDate >= startDate &&
                        (period === "all" ||
                            (period === "2024" &&
                                itemDate.getFullYear() === 2024) ||
                            (period === "2023" &&
                                itemDate.getFullYear() === 2023) ||
                            (period === "2022" &&
                                itemDate.getFullYear() === 2022) ||
                            period.startsWith("last"))
                    );
                });

                updateStats();
            }

            function updateStats() {
                updateBasicStats();
                updateInsights();
                updateTopLists();
                updateCharts();
            }

            function updateBasicStats() {
                // Basic stats
                const totalMs = filteredData.reduce(
                    (sum, item) => sum + item.ms_played,
                    0,
                );
                const totalHours = Math.round(totalMs / (1000 * 60 * 60));
                const totalTracks = filteredData.length;

                document.getElementById("totalTime").textContent =
                    `${totalHours.toLocaleString()}h`;
                document.getElementById("totalTracks").textContent =
                    `${totalTracks.toLocaleString()} tracks played`;

                // Average daily listening
                const dateRange = getDateRange(filteredData);
                const days = Math.max(1, dateRange.days);
                const avgDailyHours = Math.round((totalHours / days) * 10) / 10;
                const avgDailyTracks = Math.round(totalTracks / days);

                document.getElementById("avgDaily").textContent =
                    `${avgDailyHours}h`;
                document.getElementById("avgTracks").textContent =
                    `${avgDailyTracks} tracks per day`;

                // Unique counts
                const uniqueArtists = new Set(
                    filteredData.map(
                        (item) => item.master_metadata_album_artist_name,
                    ),
                ).size;
                const uniqueTracks = new Set(
                    filteredData.map(
                        (item) =>
                            `${item.master_metadata_track_name}-${item.master_metadata_album_artist_name}`,
                    ),
                ).size;

                document.getElementById("uniqueArtists").textContent =
                    uniqueArtists.toLocaleString();
                document.getElementById("uniqueTracks").textContent =
                    `${uniqueTracks.toLocaleString()} unique tracks`;

                // Completion rate
                const completedTracks = filteredData.filter(
                    (item) => item.ms_played > 30000,
                ).length;
                const completionRate =
                    totalTracks > 0
                        ? Math.round((completedTracks / totalTracks) * 100)
                        : 0;
                document.getElementById("skipRate").textContent =
                    `${completionRate}%`;
                document.getElementById("completionBar").style.width =
                    `${completionRate}%`;
            }

            function updateInsights() {
                // Country analysis
                const countries = {};
                filteredData.forEach((item) => {
                    if (item.conn_country) {
                        countries[item.conn_country] =
                            (countries[item.conn_country] || 0) + 1;
                    }
                });

                const countryKeys = Object.keys(countries);
                if (countryKeys.length > 0) {
                    const topCountry = countryKeys.reduce((a, b) =>
                        countries[a] > countries[b] ? a : b,
                    );
                    document.getElementById("topCountry").textContent =
                        topCountry;
                    document.getElementById("countryDetail").textContent =
                        `${countries[topCountry]?.toLocaleString() || 0} listens`;
                } else {
                    document.getElementById("topCountry").textContent = "N/A";
                    document.getElementById("countryDetail").textContent =
                        "0 listens";
                }

                // Platform analysis
                const platforms = {};
                filteredData.forEach((item) => {
                    if (item.platform) {
                        platforms[item.platform] =
                            (platforms[item.platform] || 0) + item.ms_played;
                    }
                });

                const platformKeys = Object.keys(platforms);
                if (platformKeys.length > 0) {
                    const topPlatform = platformKeys.reduce((a, b) =>
                        platforms[a] > platforms[b] ? a : b,
                    );
                    const platformHours = Math.round(
                        platforms[topPlatform] / (1000 * 60 * 60),
                    );
                    document.getElementById("topPlatform").textContent =
                        topPlatform;
                    document.getElementById("platformDetail").textContent =
                        `${platformHours} hours`;
                } else {
                    document.getElementById("topPlatform").textContent =
                        "unknown";
                    document.getElementById("platformDetail").textContent =
                        "0 hours";
                }

                // Shuffle analysis
                const shuffleTracks = filteredData.filter(
                    (item) => item.shuffle,
                ).length;
                const shuffleRate =
                    filteredData.length > 0
                        ? Math.round(
                              (shuffleTracks / filteredData.length) * 100,
                          )
                        : 0;
                document.getElementById("shuffleRate").textContent =
                    `${shuffleRate}%`;

                // Offline analysis
                const offlineTracks = filteredData.filter(
                    (item) => item.offline,
                ).length;
                const offlineRate =
                    filteredData.length > 0
                        ? Math.round(
                              (offlineTracks / filteredData.length) * 100,
                          )
                        : 0;
                document.getElementById("offlineRate").textContent =
                    `${offlineRate}%`;

                // Skip analysis
                const skippedTracks = filteredData.filter(
                    (item) => item.skipped,
                ).length;
                const actualSkipRate =
                    filteredData.length > 0
                        ? Math.round(
                              (skippedTracks / filteredData.length) * 100,
                          )
                        : 0;
                document.getElementById("actualSkipRate").textContent =
                    `${actualSkipRate}%`;

                // Discovery score
                const trackCounts = {};
                filteredData.forEach((item) => {
                    const trackKey = `${item.master_metadata_track_name}-${item.master_metadata_album_artist_name}`;
                    trackCounts[trackKey] = (trackCounts[trackKey] || 0) + 1;
                });
                const newTracks = Object.values(trackCounts).filter(
                    (count) => count === 1,
                ).length;
                document.getElementById("discoveryScore").textContent =
                    newTracks;

                // Time-based insights
                updateTimeInsights();

                // Create hourly heatmap
                createHourlyHeatmap();
            }

            function updateTimeInsights() {
                // Longest session analysis
                const sessions = calculateSessions();
                const longestSession = Math.max(
                    ...sessions.map((s) => s.duration),
                    0,
                );
                document.getElementById("longestSession").textContent =
                    `${Math.round(longestSession / (1000 * 60 * 60))}h`;

                // Most active day
                const dailyStats = calculateDailyStats();
                const days = Object.keys(dailyStats);
                if (days.length > 0) {
                    const mostActiveDay = days.reduce((a, b) =>
                        dailyStats[a].tracks > dailyStats[b].tracks ? a : b,
                    );
                    const dayData = dailyStats[mostActiveDay];
                    document.getElementById("mostActiveDay").textContent =
                        new Date(mostActiveDay).toLocaleDateString();
                    document.getElementById("activeDetails").textContent =
                        `${dayData.tracks} tracks, ${Math.round(dayData.time / (1000 * 60 * 60))}h`;
                } else {
                    document.getElementById("mostActiveDay").textContent =
                        "N/A";
                    document.getElementById("activeDetails").textContent =
                        "No data available";
                }

                // Night owl / Early bird scores
                const hourlyData = calculateHourlyDistribution();
                const nightOwlHours = hourlyData
                    .slice(22)
                    .concat(hourlyData.slice(0, 6));
                const earlyBirdHours = hourlyData.slice(5, 8);
                const totalListens = hourlyData.reduce(
                    (sum, hour) => sum + hour,
                    0,
                );

                const nightOwlScore =
                    totalListens > 0
                        ? Math.round(
                              (nightOwlHours.reduce(
                                  (sum, hour) => sum + hour,
                                  0,
                              ) /
                                  totalListens) *
                                  100,
                          )
                        : 0;
                const earlyBirdScore =
                    totalListens > 0
                        ? Math.round(
                              (earlyBirdHours.reduce(
                                  (sum, hour) => sum + hour,
                                  0,
                              ) /
                                  totalListens) *
                                  100,
                          )
                        : 0;

                document.getElementById("nightOwlScore").textContent =
                    `${nightOwlScore}%`;
                document.getElementById("earlyBirdScore").textContent =
                    `${earlyBirdScore}%`;

                // Variety score
                const varietyScore = calculateVarietyScore();
                document.getElementById("varietyScore").textContent =
                    varietyScore || 0;
            }

            function calculateSessions() {
                const sessions = [];
                let currentSession = null;

                filteredData.forEach((item) => {
                    const itemTime = new Date(item.ts).getTime();

                    if (
                        !currentSession ||
                        itemTime - currentSession.lastActivity > 30 * 60 * 1000
                    ) {
                        // 30 min gap
                        currentSession = {
                            start: itemTime,
                            lastActivity: itemTime,
                            duration: item.ms_played,
                            tracks: 1,
                        };
                        sessions.push(currentSession);
                    } else {
                        currentSession.lastActivity = itemTime;
                        currentSession.duration += item.ms_played;
                        currentSession.tracks++;
                    }
                });

                return sessions;
            }

            function calculateDailyStats() {
                const dailyData = {};

                filteredData.forEach((item) => {
                    const date = new Date(item.ts).toDateString();
                    if (!dailyData[date]) {
                        dailyData[date] = { tracks: 0, time: 0 };
                    }
                    dailyData[date].tracks++;
                    dailyData[date].time += item.ms_played;
                });

                return dailyData;
            }

            function calculateHourlyDistribution() {
                const hourlyData = new Array(24).fill(0);

                filteredData.forEach((item) => {
                    const hour = new Date(item.ts).getHours();
                    hourlyData[hour]++;
                });

                return hourlyData;
            }

            function calculateVarietyScore() {
                if (filteredData.length === 0) return 0;

                const weeklyData = {};

                filteredData.forEach((item) => {
                    if (item.ts && item.master_metadata_album_artist_name) {
                        const date = new Date(item.ts);
                        const weekKey = `${date.getFullYear()}-W${getWeekNumber(date)}`;

                        if (!weeklyData[weekKey]) {
                            weeklyData[weekKey] = new Set();
                        }
                        weeklyData[weekKey].add(
                            item.master_metadata_album_artist_name,
                        );
                    }
                });

                const weeksWithData = Object.keys(weeklyData);
                if (weeksWithData.length === 0) return 0;

                const avgArtistsPerWeek =
                    weeksWithData.reduce(
                        (sum, week) => sum + weeklyData[week].size,
                        0,
                    ) / weeksWithData.length;

                return Math.round(avgArtistsPerWeek);
            }

            function getWeekNumber(date) {
                const d = new Date(
                    Date.UTC(
                        date.getFullYear(),
                        date.getMonth(),
                        date.getDate(),
                    ),
                );
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
            }

            function createHourlyHeatmap() {
                const hourlyData = calculateHourlyDistribution();
                const maxListens = Math.max(...hourlyData);
                const heatmapContainer =
                    document.getElementById("hourlyHeatmap");
                heatmapContainer.innerHTML = "";

                // Remove any existing tooltips
                const existingTooltips =
                    document.querySelectorAll(".custom-tooltip");
                existingTooltips.forEach((tooltip) => tooltip.remove());

                // Create tooltip element
                const tooltip = document.createElement("div");
                tooltip.className = "custom-tooltip";
                document.body.appendChild(tooltip);

                hourlyData.forEach((listens, hour) => {
                    const cell = document.createElement("div");
                    cell.className = "heatmap-cell";
                    const intensity = maxListens > 0 ? listens / maxListens : 0;
                    const opacity = 0.1 + intensity * 0.9;
                    cell.style.backgroundColor = `rgba(29, 185, 84, ${opacity})`;

                    // Add custom tooltip events
                    cell.addEventListener("mouseenter", (e) => {
                        tooltip.textContent = `${hour}:00 - ${listens} listens`;
                        tooltip.classList.add("show");
                    });

                    cell.addEventListener("mousemove", (e) => {
                        tooltip.style.left = e.pageX + 10 + "px";
                        tooltip.style.top = e.pageY - 40 + "px";
                    });

                    cell.addEventListener("mouseleave", () => {
                        tooltip.classList.remove("show");
                    });

                    heatmapContainer.appendChild(cell);
                });
            }

            function updateTopLists() {
                // Top Artists
                const artistStats = {};
                filteredData.forEach((item) => {
                    const artist = item.master_metadata_album_artist_name;
                    if (!artistStats[artist]) {
                        artistStats[artist] = { time: 0, plays: 0 };
                    }
                    artistStats[artist].time += item.ms_played;
                    artistStats[artist].plays++;
                });

                topLists.artists.data = Object.entries(artistStats)
                    .map(([artist, stats]) => ({
                        name: artist,
                        time: stats.time,
                        plays: stats.plays,
                        timeText: `${Math.round(stats.time / (1000 * 60))} min`,
                        playsText: `${stats.plays} plays`,
                    }))
                    .sort((a, b) => b.time - a.time);

                // Top Tracks
                const trackStats = {};
                filteredData.forEach((item) => {
                    const track = `${item.master_metadata_track_name}`;
                    const artist = item.master_metadata_album_artist_name;
                    const key = `${track}|||${artist}`;

                    if (!trackStats[key]) {
                        trackStats[key] = { plays: 0, time: 0, track, artist };
                    }
                    trackStats[key].plays++;
                    trackStats[key].time += item.ms_played;
                });

                topLists.tracks.data = Object.values(trackStats)
                    .map((stats) => ({
                        name: `${stats.track} - ${stats.artist}`,
                        plays: stats.plays,
                        time: stats.time,
                        timeText: `${Math.round(stats.time / (1000 * 60))} min`,
                        playsText: `${stats.plays} plays`,
                    }))
                    .sort((a, b) => b.plays - a.plays);

                // Top Albums
                const albumStats = {};
                filteredData.forEach((item) => {
                    if (item.master_metadata_album_album_name) {
                        const album = `${item.master_metadata_album_album_name}`;
                        const artist = item.master_metadata_album_artist_name;
                        const key = `${album}|||${artist}`;

                        if (!albumStats[key]) {
                            albumStats[key] = {
                                time: 0,
                                plays: 0,
                                album,
                                artist,
                            };
                        }
                        albumStats[key].time += item.ms_played;
                        albumStats[key].plays++;
                    }
                });

                topLists.albums.data = Object.values(albumStats)
                    .map((stats) => ({
                        name: `${stats.album} - ${stats.artist}`,
                        time: stats.time,
                        plays: stats.plays,
                        timeText: `${Math.round(stats.time / (1000 * 60))} min`,
                        playsText: `${stats.plays} plays`,
                    }))
                    .sort((a, b) => b.time - a.time);

                // Reset filters and display
                ["artists", "tracks", "albums"].forEach((type) => {
                    topLists[type].filtered = [...topLists[type].data];
                    topLists[type].displayed = 20;
                });

                renderTopLists();
            }

            function renderTopLists() {
                ["artists", "tracks", "albums"].forEach((type) => {
                    const container = document.getElementById(
                        `top${type.charAt(0).toUpperCase() + type.slice(1)}`,
                    );
                    const items = topLists[type].filtered.slice(
                        0,
                        topLists[type].displayed,
                    );

                    container.innerHTML = items
                        .map(
                            (item, index) => `
                        <li>
                            <div class="rank">${index + 1}</div>
                            <div class="list-item-content">
                                <div class="list-item-name">${item.name}</div>
                                <div class="list-item-stats">${item.timeText} • ${item.playsText}</div>
                            </div>
                        </li>
                    `,
                        )
                        .join("");

                    // Update show more button
                    const showMoreBtn = document.getElementById(
                        `showMore${type.charAt(0).toUpperCase() + type.slice(1)}`,
                    );
                    const hasMore =
                        topLists[type].filtered.length >
                        topLists[type].displayed;
                    showMoreBtn.textContent = hasMore
                        ? `Show More (${topLists[type].filtered.length - topLists[type].displayed} remaining)`
                        : "All items shown";
                    showMoreBtn.style.display = hasMore ? "block" : "none";
                });
            }

            function filterList(type, query) {
                const lowerQuery = query.toLowerCase();
                topLists[type].filtered = topLists[type].data.filter((item) =>
                    item.name.toLowerCase().includes(lowerQuery),
                );
                topLists[type].displayed = 20;
                renderTopLists();
            }

            function showMoreItems(type) {
                topLists[type].displayed += 20;
                renderTopLists();
            }

            function updateCharts() {
                updateTimeChart();
                updatePlatformChart();
                updateCountryChart();
                updateHourlyChart();
                updateWeeklyChart();
            }

            function updateTimeChart() {
                const ctx = document.getElementById("timeChart");
                if (!ctx) return;

                const dailyData = calculateDailyStats();
                const sortedDays = Object.keys(dailyData).sort();

                // Determine selected period
                const periodSelect = document.getElementById("periodSelect");
                const period = periodSelect ? periodSelect.value : "all";

                let groupedData = {};
                let labelFormat = "month"; // default

                if (period === "last7" || period === "last30") {
                    // Group by day (YYYY-MM-DD)
                    labelFormat = "day";
                    sortedDays.forEach((day) => {
                        groupedData[day] =
                            dailyData[day].time / (1000 * 60 * 60); // hours
                    });
                } else {
                    // Group by month (YYYY-MM)
                    sortedDays.forEach((day) => {
                        const date = new Date(day);
                        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
                        if (!groupedData[key]) groupedData[key] = 0;
                        groupedData[key] +=
                            dailyData[day].time / (1000 * 60 * 60); // hours
                    });
                }

                if (charts.timeChart) charts.timeChart.destroy();

                charts.timeChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: Object.keys(groupedData),
                        datasets: [
                            {
                                label: "Hours Listened",
                                data: Object.values(groupedData),
                                borderColor: "#1db954",
                                backgroundColor: "rgba(29, 185, 84, 0.1)",
                                tension: 0.4,
                                fill: true,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                right: 10,
                                bottom: 10,
                                left: 10,
                            },
                        },
                        plugins: {
                            legend: {
                                labels: { color: "white" },
                                display: true,
                            },
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: "white",
                                    maxTicksLimit:
                                        labelFormat === "day" ? 14 : 8,
                                    callback: function (value, index, values) {
                                        // Format label as "MMM D" for day, "YYYY-MM" for month
                                        const label =
                                            this.getLabelForValue(value);
                                        if (labelFormat === "day") {
                                            const d = new Date(label);
                                            if (!isNaN(d)) {
                                                return `${d.getMonth() + 1}/${d.getDate()}`;
                                            }
                                            return label;
                                        }
                                        return label;
                                    },
                                },
                                grid: { color: "rgba(255,255,255,0.1)" },
                            },
                            y: {
                                ticks: {
                                    color: "white",
                                    beginAtZero: true,
                                },
                                grid: { color: "rgba(255,255,255,0.1)" },
                            },
                        },
                    },
                });
            }

            function updatePlatformChart() {
                const ctx = document.getElementById("platformChart");
                const listContainer = document.getElementById("platformList");
                if (!ctx || !listContainer) return;

                const platforms = {};
                filteredData.forEach((item) => {
                    if (item.platform && item.ms_played) {
                        platforms[item.platform] =
                            (platforms[item.platform] || 0) +
                            item.ms_played / (1000 * 60 * 60);
                    }
                });

                // Sort platforms by hours listened (largest to smallest)
                const sortedPlatforms = Object.entries(platforms).sort(
                    ([, a], [, b]) => b - a,
                );

                // Create/update the doughnut chart
                if (charts.platformChart) charts.platformChart.destroy();

                charts.platformChart = new Chart(ctx, {
                    type: "pie",
                    data: {
                        labels: Object.keys(platforms),
                        datasets: [
                            {
                                data: Object.values(platforms),
                                backgroundColor: [
                                    "#1db954",
                                    "#ff6b6b",
                                    "#4ecdc4",
                                    "#45b7d1",
                                    "#f9ca24",
                                    "#f0932b",
                                    "#eb4d4b",
                                    "#6c5ce7",
                                ],
                                borderWidth: 3,
                                borderColor: "#000",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: 20,
                        },
                        plugins: {
                            legend: {
                                display: false,
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || "";
                                        const value = context.parsed;
                                        const total =
                                            context.dataset.data.reduce(
                                                (a, b) => a + b,
                                                0,
                                            );
                                        const percentage = (
                                            (value / total) *
                                            100
                                        ).toFixed(1);
                                        return `${label}: ${value.toFixed(1)}h (${percentage}%)`;
                                    },
                                },
                            },
                        },
                    },
                });

                // Update the list
                listContainer.innerHTML = "";

                const totalHours = Object.values(platforms).reduce(
                    (sum, hours) => sum + hours,
                    0,
                );

                sortedPlatforms.forEach(([platform, hours]) => {
                    const item = document.createElement("div");
                    item.className = "platform-item";

                    const name = document.createElement("span");
                    name.className = "platform-name";
                    name.textContent = platform;

                    const percentage =
                        totalHours > 0
                            ? ((hours / totalHours) * 100).toFixed(1)
                            : 0;
                    const hoursSpan = document.createElement("span");
                    hoursSpan.className = "platform-hours";
                    hoursSpan.textContent = `${hours.toFixed(1)} hours (${percentage}%)`;

                    item.appendChild(name);
                    item.appendChild(hoursSpan);
                    listContainer.appendChild(item);
                });
            }

            function updateCountryChart() {
                const ctx = document.getElementById("countryChart");
                if (!ctx) return;

                const countries = {};
                filteredData.forEach((item) => {
                    if (item.conn_country) {
                        countries[item.conn_country] =
                            (countries[item.conn_country] || 0) + 1;
                    }
                });

                // Get top 5 countries
                const topCountries = Object.entries(countries)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5);

                if (charts.countryChart) charts.countryChart.destroy();

                charts.countryChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: topCountries.map(([country]) => country),
                        datasets: [
                            {
                                label: "Listens",
                                data: topCountries.map(([, count]) => count),
                                backgroundColor: "#1db954",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                right: 10,
                                bottom: 10,
                                left: 10,
                            },
                        },
                        plugins: {
                            legend: {
                                labels: { color: "white" },
                                display: false,
                            },
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: "white",
                                    maxRotation: 45,
                                },
                                grid: { color: "rgba(255,255,255,0.1)" },
                            },
                            y: {
                                ticks: {
                                    color: "white",
                                    beginAtZero: true,
                                },
                                grid: { color: "rgba(255,255,255,0.1)" },
                            },
                        },
                    },
                });
            }

            function updateHourlyChart() {
                const ctx = document.getElementById("hourlyChart");
                if (!ctx) return;

                const hourlyData = calculateHourlyDistribution();

                if (charts.hourlyChart) charts.hourlyChart.destroy();

                charts.hourlyChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: [
                            {
                                label: "Listens",
                                data: hourlyData,
                                backgroundColor: "#1db954",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                right: 10,
                                bottom: 10,
                                left: 10,
                            },
                        },
                        plugins: {
                            legend: {
                                labels: { color: "white" },
                                display: false,
                            },
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: "white",
                                    maxTicksLimit: 12,
                                },
                                grid: { color: "rgba(255,255,255,0.1)" },
                            },
                            y: {
                                ticks: {
                                    color: "white",
                                    beginAtZero: true,
                                },
                                grid: { color: "rgba(255,255,255,0.1)" },
                            },
                        },
                    },
                });
            }

            function updateWeeklyChart() {
                const ctx = document.getElementById("weeklyChart");
                if (!ctx) return;

                const weeklyData = [0, 0, 0, 0, 0, 0, 0]; // Sun-Sat
                filteredData.forEach((item) => {
                    if (item.ts && item.ms_played) {
                        const day = new Date(item.ts).getDay();
                        weeklyData[day] += item.ms_played / (1000 * 60 * 60);
                    }
                });

                const dayNames = [
                    "Sunday",
                    "Monday",
                    "Tuesday",
                    "Wednesday",
                    "Thursday",
                    "Friday",
                    "Saturday",
                ];

                if (charts.weeklyChart) charts.weeklyChart.destroy();

                charts.weeklyChart = new Chart(ctx, {
                    type: "radar",
                    data: {
                        labels: dayNames,
                        datasets: [
                            {
                                label: "Hours Listened",
                                data: weeklyData,
                                borderColor: "#1db954",
                                backgroundColor: "rgba(29, 185, 84, 0.2)",
                                pointBackgroundColor: "#1db954",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: 60,
                        },
                        plugins: {
                            legend: {
                                labels: { color: "white" },
                                display: false,
                            },
                        },
                        scales: {
                            r: {
                                min: 0,
                                ticks: {
                                    color: "white",
                                    beginAtZero: true,
                                    stepSize: undefined,
                                },
                                grid: { color: "rgba(255,255,255,0.1)" },
                                pointLabels: {
                                    color: "white",
                                    font: {
                                        size: 14,
                                    },
                                },
                            },
                        },
                    },
                });
            }

            function getDateRange(data) {
                if (data.length === 0)
                    return { days: 1, start: new Date(), end: new Date() };

                const dates = data.map((item) => new Date(item.ts));
                const start = new Date(Math.min(...dates));
                const end = new Date(Math.max(...dates));
                const days = Math.max(
                    1,
                    Math.ceil((end - start) / (1000 * 60 * 60 * 24)),
                );

                return { days, start, end };
            }

            // Event listeners
            document
                .getElementById("fileInput")
                .addEventListener("change", function (e) {
                    const file = e.target.files[0];
                    if (file && file.type === "application/zip") {
                        processZipFile(file);
                    } else {
                        showErrorView(
                            "Please select a valid ZIP file containing your Spotify data.",
                        );
                    }
                });

            document
                .getElementById("periodSelect")
                .addEventListener("change", (e) => {
                    applyFilter(e.target.value);
                });

            // Drag and drop functionality
            const dropZone = document.getElementById("dropZone");

            dropZone.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZone.classList.add("dragover");
            });

            dropZone.addEventListener("dragleave", (e) => {
                e.preventDefault();
                dropZone.classList.remove("dragover");
            });

            dropZone.addEventListener("drop", (e) => {
                e.preventDefault();
                dropZone.classList.remove("dragover");

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === "application/zip") {
                    processZipFile(files[0]);
                } else {
                    showErrorView(
                        "Please drop a valid ZIP file containing your Spotify data.",
                    );
                }
            });

            // Initialize with upload view
            showUploadView();
        </script>
    </body>
</html>
