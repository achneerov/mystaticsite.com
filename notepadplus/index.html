<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Notepad Plus</title>
        <!-- Prettier libraries -->
        <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
        <script src="https://unpkg.com/prettier@2.8.8/parser-html.js"></script>
        <script src="https://unpkg.com/prettier@2.8.8/parser-postcss.js"></script>
        <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --bg-primary: #1e1e1e;
                --bg-secondary: #2d2d30;
                --bg-tertiary: #3e3e42;
                --text-primary: #ffffff;
                --text-secondary: #cccccc;
                --text-muted: #999;
                --border-color: #3e3e42;
                --accent-color: #007acc;
                --accent-hover: #1177bb;
                --button-bg: #0e639c;
                --button-hover: #1177bb;
                --success-color: #4caf50;
                --error-color: #f44336;
                --shadow: rgba(0, 0, 0, 0.3);
                --tab-active-bg: #1e1e1e;
                --tab-inactive-bg: #3e3e42;
            }

            [data-theme="light"] {
                --bg-primary: #ffffff;
                --bg-secondary: #f5f5f5;
                --bg-tertiary: #e0e0e0;
                --text-primary: #000000;
                --text-secondary: #333333;
                --text-muted: #666666;
                --border-color: #d0d0d0;
                --accent-color: #0066cc;
                --accent-hover: #0052a3;
                --button-bg: #0066cc;
                --button-hover: #0052a3;
                --success-color: #4caf50;
                --error-color: #d32f2f;
                --shadow: rgba(0, 0, 0, 0.1);
                --tab-active-bg: #0066cc;
                --tab-inactive-bg: #e0e0e0;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                height: 100vh;
                display: flex;
                flex-direction: column;
                transition:
                    background-color 0.3s ease,
                    color 0.3s ease;
            }

            .header {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                padding: 10px 15px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 15px;
                flex-wrap: wrap;
                transition:
                    background-color 0.3s ease,
                    border-color 0.3s ease;
            }

            .header-left {
                display: flex;
                align-items: center;
                gap: 15px;
                flex: 1;
                min-width: 0;
            }

            .header h1 {
                color: var(--text-primary);
                font-size: 20px;
                white-space: nowrap;
            }

            .prettify-section {
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
                min-width: 0;
            }

            .prettify-label {
                color: var(--text-secondary);
                font-size: 14px;
                font-weight: 500;
                white-space: nowrap;
            }

            .prettify-buttons {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .prettify-btn {
                background: var(--button-bg);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: background 0.2s;
            }

            .prettify-btn:hover {
                background: var(--button-hover);
            }

            .prettify-btn:disabled {
                background: var(--text-muted);
                cursor: not-allowed;
            }

            .header-right {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .nav-link {
                color: var(--text-secondary);
                text-decoration: none;
                font-size: 14px;
                transition: color 0.2s;
                white-space: nowrap;
            }

            .nav-link:hover {
                color: var(--accent-color);
            }

            .theme-toggle {
                background: var(--bg-tertiary);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.2s;
                white-space: nowrap;
            }

            .theme-toggle:hover {
                background: var(--accent-color);
                color: white;
            }

            .tab-container {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                padding: 0 0 0 10px;
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                min-height: 40px;
                transition:
                    background-color 0.3s ease,
                    border-color 0.3s ease;
            }

            .tab-container::-webkit-scrollbar {
                height: 6px;
            }

            .tab-container::-webkit-scrollbar-track {
                background: var(--bg-secondary);
            }

            .tab-container::-webkit-scrollbar-thumb {
                background: var(--text-muted);
                border-radius: 3px;
            }

            .tab-container::-webkit-scrollbar-thumb:hover {
                background: var(--text-secondary);
            }

            #tabs {
                display: flex;
                align-items: center;
                flex-shrink: 0;
                position: relative;
            }

            .tab {
                background: var(--tab-inactive-bg);
                border: none;
                color: var(--text-secondary);
                padding: 8px 15px;
                cursor: pointer;
                border-top-left-radius: 4px;
                border-top-right-radius: 4px;
                margin-right: 2px;
                white-space: nowrap;
                display: flex;
                align-items: center;
                gap: 8px;
                min-width: 120px;
                max-width: 200px;
                justify-content: space-between;
                flex-shrink: 0;
                position: relative;
                user-select: none;
                transition:
                    transform 0.2s ease,
                    box-shadow 0.2s ease,
                    background-color 0.3s ease,
                    color 0.3s ease;
            }

            .tab.active {
                background: var(--tab-active-bg);
                color: var(--text-primary);
            }

            [data-theme="light"] .tab.active {
                color: white;
            }

            .tab:hover {
                background: var(--tab-inactive-bg);
                filter: brightness(1.1);
            }

            .tab.active:hover {
                background: var(--tab-active-bg);
            }

            .tab.dragging {
                z-index: 1000;
                transform: scale(1.05) rotate(2deg);
                box-shadow: 0 8px 16px var(--shadow);
                opacity: 0.9;
                position: fixed;
                pointer-events: none;
            }

            .tab.drag-placeholder {
                opacity: 0.5;
                background: transparent;
                border: 2px dashed var(--accent-color);
                color: transparent;
            }

            .tab-name {
                flex: 1;
                cursor: pointer;
                overflow: hidden;
                text-overflow: ellipsis;
                padding: 2px 4px;
                border-radius: 2px;
            }

            .tab-name.editing {
                background: var(--bg-tertiary);
                border: 1px solid var(--accent-color);
                outline: none;
                cursor: text;
            }

            .tab-close {
                background: none;
                border: none;
                color: var(--text-muted);
                cursor: pointer;
                font-size: 14px;
                padding: 2px;
                border-radius: 2px;
                flex-shrink: 0;
            }

            .tab-close:hover {
                background: var(--text-muted);
                color: var(--text-primary);
            }

            .add-tab-btn {
                background: var(--button-bg);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 10px;
                font-size: 12px;
                flex-shrink: 0;
                transition: background 0.2s;
            }

            .add-tab-btn:hover {
                background: var(--button-hover);
            }

            .editor-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .textarea-container {
                flex: 1;
                position: relative;
            }

            .editor-textarea {
                width: 100%;
                height: 100%;
                background: var(--bg-primary);
                color: var(--text-primary);
                border: none;
                font-family: "Consolas", "Monaco", "Courier New", monospace;
                font-size: 14px;
                line-height: 1.5;
                padding: 15px;
                resize: none;
                outline: none;
                transition:
                    background-color 0.3s ease,
                    color 0.3s ease;
            }

            .editor-textarea::placeholder {
                color: var(--text-muted);
            }

            .empty-state {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: var(--text-muted);
                font-size: 18px;
            }

            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 16px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                z-index: 1000;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                box-shadow: 0 4px 12px var(--shadow);
            }

            .notification.show {
                transform: translateX(0);
            }

            .notification.error {
                background: var(--error-color);
                color: white;
            }

            @media (max-width: 768px) {
                .header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 10px;
                }

                .header-left {
                    width: 100%;
                    flex-direction: column;
                    align-items: flex-start;
                }

                .prettify-section {
                    width: 100%;
                    justify-content: flex-start;
                }

                .header-right {
                    align-self: flex-end;
                }

                .tab {
                    min-width: 100px;
                    font-size: 12px;
                }

                .notification {
                    top: 10px;
                    right: 10px;
                    font-size: 13px;
                }
            }
        </style>
    </head>
    <body data-theme="dark">
        <div class="header">
            <div class="header-left">
                <h1>Notepad Plus</h1>
                <div class="prettify-section">
                    <span class="prettify-label">Format Selected Text:</span>
                    <div class="prettify-buttons">
                        <button
                            class="prettify-btn"
                            onclick="prettifySelection('html')"
                        >
                            HTML
                        </button>
                        <button
                            class="prettify-btn"
                            onclick="prettifySelection('css')"
                        >
                            CSS
                        </button>
                        <button
                            class="prettify-btn"
                            onclick="prettifySelection('javascript')"
                        >
                            JS/TS
                        </button>
                        <button
                            class="prettify-btn"
                            onclick="prettifySelection('json')"
                        >
                            JSON
                        </button>
                        <button
                            class="prettify-btn"
                            onclick="prettifySelection('csharp')"
                        >
                            C#
                        </button>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <a href="../index.html" class="nav-link">My Other Sites</a>
                <button class="theme-toggle" onclick="toggleTheme()">
                    🌙 Dark
                </button>
            </div>
        </div>

        <div class="tab-container">
            <button class="add-tab-btn" onclick="createNewTab()">
                + New Tab
            </button>
            <div id="tabs"></div>
        </div>

        <div class="editor-container">
            <div class="textarea-container">
                <textarea
                    id="editor"
                    class="editor-textarea"
                    placeholder="Start typing your notes..."
                ></textarea>
                <div id="empty-state" class="empty-state" style="display: none">
                    Click "+ New Tab" to create your first note
                </div>
            </div>
        </div>

        <script>
            class NotepadPlus {
                constructor() {
                    this.tabs = [];
                    this.activeTabId = null;
                    this.editor = document.getElementById("editor");
                    this.saveTimeout = null;
                    this.draggedTab = null;
                    this.draggedElement = null;
                    this.placeholderElement = null;
                    this.isDragging = false;
                    this.dragTimer = null;
                    this.initialMouseX = 0;
                    this.initialMouseY = 0;
                    this.dragThreshold = 5; // pixels to start drag

                    this.init();
                }

                init() {
                    this.loadFromStorage();
                    this.setupEventListeners();

                    if (this.tabs.length === 0) {
                        this.showEmptyState();
                    } else {
                        this.renderTabs();
                        this.switchToTab(this.activeTabId || this.tabs[0].id);
                    }
                }

                showEmptyState() {
                    document.getElementById("empty-state").style.display =
                        "flex";
                    this.editor.style.display = "none";
                }

                hideEmptyState() {
                    document.getElementById("empty-state").style.display =
                        "none";
                    this.editor.style.display = "block";
                }

                setupEventListeners() {
                    this.editor.addEventListener("input", () => {
                        this.updateActiveTabContent();
                        this.debouncedSave();
                    });

                    this.editor.addEventListener("keydown", (e) => {
                        if (e.ctrlKey && e.key === "s") {
                            e.preventDefault();
                            this.saveToStorage();
                        }
                    });

                    // Global mouse events for drag and drop
                    document.addEventListener("mousemove", (e) => {
                        // Check if we should start dragging based on mouse movement
                        if (this.draggedTab && !this.isDragging) {
                            const deltaX = Math.abs(
                                e.clientX - this.initialMouseX,
                            );
                            const deltaY = Math.abs(
                                e.clientY - this.initialMouseY,
                            );

                            if (
                                deltaX > this.dragThreshold ||
                                deltaY > this.dragThreshold
                            ) {
                                if (this.dragTimer) {
                                    clearTimeout(this.dragTimer);
                                    this.dragTimer = null;
                                }
                                this.initiateDrag(this.draggedTab);
                            }
                        }

                        if (this.isDragging && this.draggedElement) {
                            this.draggedElement.style.left =
                                e.clientX - 60 + "px";
                            this.draggedElement.style.top =
                                e.clientY - 20 + "px";

                            // Check for hover over any tab for better responsiveness
                            const tabElements = document.querySelectorAll(
                                ".tab:not(.drag-placeholder):not(.dragging)",
                            );
                            let foundHover = false;

                            for (const tabElement of tabElements) {
                                const rect = tabElement.getBoundingClientRect();
                                if (
                                    e.clientX >= rect.left &&
                                    e.clientX <= rect.right &&
                                    e.clientY >= rect.top &&
                                    e.clientY <= rect.bottom
                                ) {
                                    this.handleDragOver(e, tabElement);
                                    foundHover = true;
                                    break;
                                }
                            }

                            // Also check the tabs container for edge cases
                            if (!foundHover) {
                                const tabsContainer =
                                    document.getElementById("tabs");
                                const containerRect =
                                    tabsContainer.getBoundingClientRect();
                                if (
                                    e.clientX >= containerRect.left &&
                                    e.clientX <= containerRect.right &&
                                    e.clientY >= containerRect.top &&
                                    e.clientY <= containerRect.bottom
                                ) {
                                    // Handle dragging at the edges of the tabs container
                                    this.handleContainerDragOver(e);
                                }
                            }
                        }
                    });

                    document.addEventListener("mouseup", () => {
                        if (this.dragTimer) {
                            clearTimeout(this.dragTimer);
                            this.dragTimer = null;
                        }
                        if (this.isDragging) {
                            this.endDrag();
                        }
                        // Clean up drag state
                        this.draggedTab = null;
                    });
                }

                debouncedSave() {
                    if (this.saveTimeout) {
                        clearTimeout(this.saveTimeout);
                    }

                    this.saveTimeout = setTimeout(() => {
                        this.saveToStorage();
                    }, 500);
                }

                showNotification(message, type = "error") {
                    const existingNotifications =
                        document.querySelectorAll(".notification");
                    existingNotifications.forEach((notification) => {
                        document.body.removeChild(notification);
                    });

                    const notification = document.createElement("div");
                    notification.className = `notification ${type}`;
                    notification.textContent = message;

                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.classList.add("show");
                    }, 100);

                    setTimeout(() => {
                        notification.classList.remove("show");
                        setTimeout(() => {
                            if (document.body.contains(notification)) {
                                document.body.removeChild(notification);
                            }
                        }, 300);
                    }, 3000);
                }

                createTab(name, content = "") {
                    const id = Date.now().toString();
                    const tab = {
                        id: id,
                        name: name,
                        content: content,
                    };

                    this.tabs.push(tab);
                    this.activeTabId = id;
                    this.saveToStorage();
                    return tab;
                }

                createNewTab() {
                    // First save current tab content before switching
                    this.updateActiveTabContent();

                    this.hideEmptyState();
                    const tab = this.createTab("Untitled");

                    // Clear editor before switching to ensure new tab starts empty
                    this.editor.value = "";

                    this.renderTabs();
                    this.switchToTab(tab.id);
                }

                startTabEdit(tabId) {
                    const tab = this.tabs.find((t) => t.id === tabId);
                    if (!tab) return;

                    const tabElement = document.querySelector(
                        `[data-tab-id="${tabId}"]`,
                    );
                    const nameElement = tabElement.querySelector(".tab-name");

                    nameElement.contentEditable = true;
                    nameElement.classList.add("editing");
                    nameElement.focus();

                    const range = document.createRange();
                    range.selectNodeContents(nameElement);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);

                    let isFinished = false;

                    const finishEdit = () => {
                        if (isFinished) return;
                        isFinished = true;

                        nameElement.contentEditable = false;
                        nameElement.classList.remove("editing");
                        const newName =
                            nameElement.textContent.trim() || "Untitled";
                        tab.name = newName;
                        nameElement.textContent = newName;
                        this.saveToStorage();

                        // Clean up event listeners
                        nameElement.removeEventListener("blur", finishEdit);
                        nameElement.removeEventListener(
                            "keydown",
                            keydownHandler,
                        );
                    };

                    const keydownHandler = (e) => {
                        if (e.key === "Enter") {
                            e.preventDefault();
                            finishEdit();
                        } else if (e.key === "Escape") {
                            nameElement.textContent = tab.name;
                            finishEdit();
                        }
                    };

                    nameElement.addEventListener("blur", finishEdit);
                    nameElement.addEventListener("keydown", keydownHandler);
                }

                closeTab(tabId) {
                    const tabIndex = this.tabs.findIndex((t) => t.id === tabId);
                    if (tabIndex === -1) return;

                    this.tabs.splice(tabIndex, 1);

                    if (this.tabs.length === 0) {
                        this.activeTabId = null;
                        this.editor.value = "";
                        this.showEmptyState();
                        this.saveToStorage();
                        this.renderTabs(); // This will clear the tabs container
                        return;
                    }

                    if (this.activeTabId === tabId) {
                        const newActiveIndex = Math.max(0, tabIndex - 1);
                        this.activeTabId = this.tabs[newActiveIndex].id;
                        this.switchToTab(this.activeTabId);
                    }

                    this.saveToStorage();
                    this.renderTabs();
                }

                switchToTab(tabId) {
                    // Don't save content if we're switching to an empty new tab
                    if (this.activeTabId && this.activeTabId !== tabId) {
                        this.updateActiveTabContent();
                    }

                    const tab = this.tabs.find((t) => t.id === tabId);
                    if (!tab) return;

                    this.activeTabId = tabId;
                    this.editor.value = tab.content;
                    this.saveToStorage();
                    this.renderTabs();
                }

                updateActiveTabContent() {
                    const activeTab = this.tabs.find(
                        (t) => t.id === this.activeTabId,
                    );
                    if (activeTab) {
                        activeTab.content = this.editor.value;
                    }
                }

                startDragHold(e, tabId) {
                    if (e.button !== 0) return; // Only left mouse button

                    this.draggedTab = tabId;
                    this.initialMouseX = e.clientX;
                    this.initialMouseY = e.clientY;

                    // Set up a timer to start drag after 150ms
                    this.dragTimer = setTimeout(() => {
                        if (this.draggedTab === tabId) {
                            this.initiateDrag(tabId);
                        }
                    }, 150);

                    e.preventDefault();
                }

                initiateDrag(tabId) {
                    this.isDragging = true;

                    const tabElement = document.querySelector(
                        `[data-tab-id="${tabId}"]`,
                    );
                    this.draggedElement = tabElement.cloneNode(true);

                    // Style the dragged element
                    this.draggedElement.classList.add("dragging");
                    this.draggedElement.style.position = "fixed";
                    this.draggedElement.style.zIndex = "1000";
                    this.draggedElement.style.pointerEvents = "none";

                    // Set initial position to prevent jump to top-left corner
                    this.draggedElement.style.left =
                        this.initialMouseX - 60 + "px";
                    this.draggedElement.style.top =
                        this.initialMouseY - 20 + "px";

                    document.body.appendChild(this.draggedElement);

                    // Create placeholder
                    this.placeholderElement = tabElement.cloneNode(true);
                    this.placeholderElement.classList.add("drag-placeholder");
                    this.placeholderElement.style.pointerEvents = "none";

                    tabElement.parentNode.insertBefore(
                        this.placeholderElement,
                        tabElement.nextSibling,
                    );
                    tabElement.style.display = "none";
                }

                endDrag() {
                    if (!this.isDragging) return;

                    this.isDragging = false;

                    // Clean up dragged element
                    if (
                        this.draggedElement &&
                        document.body.contains(this.draggedElement)
                    ) {
                        document.body.removeChild(this.draggedElement);
                    }

                    // Show original tab
                    const originalTab = document.querySelector(
                        `[data-tab-id="${this.draggedTab}"]`,
                    );
                    if (originalTab) {
                        originalTab.style.display = "flex";
                    }

                    // Find final position based on placeholder
                    if (this.placeholderElement) {
                        const placeholderIndex = Array.from(
                            this.placeholderElement.parentNode.children,
                        ).indexOf(this.placeholderElement);
                        const draggedIndex = this.tabs.findIndex(
                            (t) => t.id === this.draggedTab,
                        );

                        if (draggedIndex !== -1) {
                            const [draggedTab] = this.tabs.splice(
                                draggedIndex,
                                1,
                            );
                            let insertIndex = placeholderIndex;

                            // Adjust for removed element
                            if (draggedIndex < insertIndex) {
                                insertIndex--;
                            }

                            this.tabs.splice(insertIndex, 0, draggedTab);
                            this.saveToStorage();
                        }

                        this.placeholderElement.parentNode.removeChild(
                            this.placeholderElement,
                        );
                    }

                    // Clean up
                    this.draggedTab = null;
                    this.draggedElement = null;
                    this.placeholderElement = null;

                    this.renderTabs();
                }

                handleDragOver(e, targetElement) {
                    if (!this.isDragging || !this.placeholderElement) return;

                    const rect = targetElement.getBoundingClientRect();
                    const midpoint = rect.left + rect.width / 2;
                    const insertBefore = e.clientX < midpoint;

                    // Remove placeholder from current position
                    if (this.placeholderElement.parentNode) {
                        this.placeholderElement.parentNode.removeChild(
                            this.placeholderElement,
                        );
                    }

                    // Insert placeholder in new position
                    const tabsContainer = document.getElementById("tabs");
                    if (insertBefore) {
                        tabsContainer.insertBefore(
                            this.placeholderElement,
                            targetElement,
                        );
                    } else {
                        if (targetElement.nextSibling) {
                            tabsContainer.insertBefore(
                                this.placeholderElement,
                                targetElement.nextSibling,
                            );
                        } else {
                            tabsContainer.appendChild(this.placeholderElement);
                        }
                    }
                }

                handleContainerDragOver(e) {
                    if (!this.isDragging || !this.placeholderElement) return;

                    const tabsContainer = document.getElementById("tabs");
                    const containerRect = tabsContainer.getBoundingClientRect();

                    // If dragging past the end of tabs, move placeholder to end
                    if (e.clientX > containerRect.right - 50) {
                        if (this.placeholderElement.parentNode) {
                            this.placeholderElement.parentNode.removeChild(
                                this.placeholderElement,
                            );
                        }
                        tabsContainer.appendChild(this.placeholderElement);
                    }
                    // If dragging before the first tab, move placeholder to beginning
                    else if (e.clientX < containerRect.left + 50) {
                        if (this.placeholderElement.parentNode) {
                            this.placeholderElement.parentNode.removeChild(
                                this.placeholderElement,
                            );
                        }
                        const firstTab = tabsContainer.querySelector(
                            ".tab:not(.drag-placeholder)",
                        );
                        if (firstTab) {
                            tabsContainer.insertBefore(
                                this.placeholderElement,
                                firstTab,
                            );
                        } else {
                            tabsContainer.appendChild(this.placeholderElement);
                        }
                    }
                }

                renderTabs() {
                    const tabsContainer = document.getElementById("tabs");
                    tabsContainer.innerHTML = "";

                    this.tabs.forEach((tab) => {
                        const tabElement = document.createElement("div");
                        tabElement.className = `tab ${tab.id === this.activeTabId ? "active" : ""}`;
                        tabElement.dataset.tabId = tab.id;

                        tabElement.innerHTML = `
                            <span class="tab-name">${tab.name}</span>
                            <button class="tab-close" title="Close tab">×</button>
                        `;

                        const nameElement =
                            tabElement.querySelector(".tab-name");
                        const closeButton =
                            tabElement.querySelector(".tab-close");

                        // Click to switch tabs
                        nameElement.addEventListener("click", () => {
                            this.switchToTab(tab.id);
                        });

                        // Double-click to rename
                        nameElement.addEventListener("dblclick", (e) => {
                            e.stopPropagation();
                            this.startTabEdit(tab.id);
                        });

                        // Close button
                        closeButton.addEventListener("click", (e) => {
                            e.stopPropagation();
                            this.closeTab(tab.id);
                        });

                        // Hold to drag (only on the tab element, not close button)
                        nameElement.addEventListener("mousedown", (e) => {
                            this.startDragHold(e, tab.id);
                        });

                        // Drag over for reordering
                        tabElement.addEventListener("mouseover", (e) => {
                            if (this.isDragging && this.draggedTab !== tab.id) {
                                this.handleDragOver(e, tabElement);
                            }
                        });

                        tabsContainer.appendChild(tabElement);
                    });
                }

                saveToStorage() {
                    const data = {
                        tabs: this.tabs,
                        activeTabId: this.activeTabId,
                    };
                    localStorage.setItem(
                        "notepadplus-data",
                        JSON.stringify(data),
                    );
                }

                loadFromStorage() {
                    const saved = localStorage.getItem("notepadplus-data");
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            this.tabs = data.tabs || [];
                            this.activeTabId = data.activeTabId;
                        } catch (e) {
                            console.error("Failed to load saved data:", e);
                            this.tabs = [];
                            this.activeTabId = null;
                        }
                    }
                }

                getSelectedText() {
                    const start = this.editor.selectionStart;
                    const end = this.editor.selectionEnd;
                    return {
                        text: this.editor.value.substring(start, end),
                        start: start,
                        end: end,
                    };
                }

                replaceSelectedText(newText) {
                    const start = this.editor.selectionStart;
                    const end = this.editor.selectionEnd;
                    const value = this.editor.value;

                    this.editor.value =
                        value.substring(0, start) +
                        newText +
                        value.substring(end);
                    this.editor.setSelectionRange(
                        start,
                        start + newText.length,
                    );
                    this.editor.focus();

                    this.updateActiveTabContent();
                    this.debouncedSave();
                }

                prettifyCode(code, language) {
                    try {
                        switch (language) {
                            case "json":
                                return prettier.format(code, {
                                    parser: "json",
                                    plugins: prettierPlugins,
                                });

                            case "html":
                                return prettier.format(code, {
                                    parser: "html",
                                    plugins: prettierPlugins,
                                    printWidth: 80,
                                    tabWidth: 2,
                                });

                            case "css":
                                return prettier.format(code, {
                                    parser: "css",
                                    plugins: prettierPlugins,
                                    printWidth: 80,
                                    tabWidth: 2,
                                });

                            case "javascript":
                                return prettier.format(code, {
                                    parser: "babel",
                                    plugins: prettierPlugins,
                                    printWidth: 80,
                                    tabWidth: 2,
                                    semi: true,
                                    singleQuote: false,
                                });

                            case "csharp":
                                // Keep the C# formatter since Prettier doesn't support it
                                return this.formatCSharp(code);

                            default:
                                return code;
                        }
                    } catch (e) {
                        throw new Error(
                            `Failed to format ${language}: ${e.message}`,
                        );
                    }
                }

                formatCSharp(code) {
                    let formatted = "";
                    let indent = 0;
                    const tab = "    ";
                    let inString = false;
                    let inComment = false;

                    for (let i = 0; i < code.length; i++) {
                        const char = code[i];
                        const nextChar = code[i + 1];
                        const prevChar = code[i - 1];

                        if (char === '"' && prevChar !== "\\" && !inComment) {
                            inString = !inString;
                        }

                        if (char === "/" && nextChar === "/" && !inString) {
                            inComment = true;
                        }
                        if (char === "\n") {
                            inComment = false;
                        }

                        if (!inString && !inComment) {
                            if (char === "{") {
                                formatted += char + "\n" + tab.repeat(++indent);
                            } else if (char === "}") {
                                formatted =
                                    formatted.trim() +
                                    "\n" +
                                    tab.repeat(--indent) +
                                    char +
                                    "\n" +
                                    tab.repeat(indent);
                            } else if (char === ";") {
                                formatted += char + "\n" + tab.repeat(indent);
                            } else {
                                formatted += char;
                            }
                        } else {
                            formatted += char;
                        }
                    }

                    return formatted.trim();
                }
            }

            function prettifySelection(language) {
                const selection = notepad.getSelectedText();

                if (!selection.text.trim()) {
                    notepad.showNotification(
                        "Please select text to format",
                        "error",
                    );
                    return;
                }

                try {
                    const prettified = notepad.prettifyCode(
                        selection.text,
                        language,
                    );
                    notepad.replaceSelectedText(prettified);
                } catch (e) {
                    notepad.showNotification(`Error: ${e.message}`, "error");
                }
            }

            function createNewTab() {
                notepad.createNewTab();
            }

            function toggleTheme() {
                const body = document.body;
                const themeToggle = document.querySelector(".theme-toggle");

                if (body.getAttribute("data-theme") === "dark") {
                    body.setAttribute("data-theme", "light");
                    themeToggle.innerHTML = "☀️ Light";
                    localStorage.setItem("notepad-theme", "light");
                } else {
                    body.setAttribute("data-theme", "dark");
                    themeToggle.innerHTML = "🌙 Dark";
                    localStorage.setItem("notepad-theme", "dark");
                }
            }

            // Load saved theme
            function loadTheme() {
                const savedTheme =
                    localStorage.getItem("notepad-theme") || "dark";
                const body = document.body;
                const themeToggle = document.querySelector(".theme-toggle");

                body.setAttribute("data-theme", savedTheme);
                if (savedTheme === "light") {
                    themeToggle.innerHTML = "☀️ Light";
                } else {
                    themeToggle.innerHTML = "🌙 Dark";
                }
            }

            // Wait for Prettier to load
            window.addEventListener("load", () => {
                // Initialize the application after Prettier loads
                window.notepad = new NotepadPlus();
                loadTheme();

                window.addEventListener("beforeunload", (e) => {
                    notepad.updateActiveTabContent();
                    notepad.saveToStorage();
                });
            });
        </script>
    </body>
</html>
